<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FENÓMENO Bar Ops</title>

    <!-- PWA Config -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="icon" href="./icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fenómeno">

    <!-- Bibliotecas vía CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.330.0"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #f4f4f5;
        }

        .animate-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .task-row:hover .drag-icon {
            opacity: 1;
        }

        .drag-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        @media print {
            * {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }

            html,
            body {
                height: auto !important;
                overflow: visible !important;
            }

            body {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .pdf-page {
                page-break-after: always;
                padding: 20px;
            }

            .pdf-header {
                font-size: 24px;
                font-weight: 900;
                text-transform: uppercase;
                border-bottom: 2px solid #ccc;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .pdf-section {
                margin-bottom: 30px;
                page-break-inside: avoid;
            }

            .pdf-section-title {
                font-size: 16px;
                font-weight: bold;
                background: #f3f4f6;
                padding: 8px;
                border-radius: 4px;
                margin-bottom: 10px;
            }

            .pdf-item {
                font-size: 12px;
                margin-bottom: 15px;
                border: 1px solid #eee;
                padding: 10px;
                border-radius: 8px;
            }

            .pdf-task {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px solid #f9f9f9;
                padding: 4px 0;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Carga de Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWO05LJao0ZWIH65hIBaGSrREXWKASFMU",
            authDomain: "fenomeno---bar-ops.firebaseapp.com",
            projectId: "fenomeno---bar-ops",
            storageBucket: "fenomeno---bar-ops.firebasestorage.app",
            messagingSenderId: "166164759157",
            appId: "1:166164759157:web:60366f50df3ee0d574ee3c",
            measurementId: "G-FGMDNW8WHY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "fenomeno-ops-v10"; // Bump to v10 to re-seed configs and inventories

        window.FB = {
            db, auth, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, query, getDocs,
            signInAnonymously, onAuthStateChanged, appId
        };
    </script>

    <!-- Código de la Aplicación -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('user');
            const [activeChecklist, setActiveChecklist] = useState(null);
            const [checklists, setChecklists] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [userActiveTab, setUserActiveTab] = useState('resumen');

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB) {
                        clearInterval(checkFB);
                        initApp();
                    }
                }, 100);

                const initApp = async () => {
                    const { auth, db, appId, collection, onSnapshot, signInAnonymously, onAuthStateChanged } = window.FB;

                    onAuthStateChanged(auth, (u) => {
                        if (!u) { signInAnonymously(auth).catch(console.error); }
                        setUser(u);
                        setLoading(false);
                    });

                    const qChecklists = collection(db, 'artifacts', appId, 'public', 'data', 'checklists');
                    onSnapshot(qChecklists, (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (list.length === 0) seedFenomenoData();
                        setChecklists(list);
                    });

                    const qSubmissions = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
                    onSnapshot(qSubmissions, (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSubmissions(list.sort((a, b) => b.timestamp - a.timestamp));
                    });
                };
                return () => clearInterval(checkFB);
            }, []);

            const seedFenomenoData = async () => {
                const { db, collection, addDoc, doc, setDoc, appId } = window.FB;
                const defaultLists = [
                    {
                        title: "Apertura Barra Principal", category: "Apertura", area: "Barra Principal", type: "standard",
                        tasks: [
                            "Colocar cristalería en hielo (Estación 1 y 2)",
                            "Montar estaciones completamente (Mise en place)",
                            "Rellenar batches y premix según rotación",
                            "Comprobar stock de premix, frutas y garnish",
                            "Rellenar stock de hielos (Estaciones y reserva)",
                            "Vaciar basuras antes del inicio del servicio",
                            "Rellenar aperitivos y snacks",
                            "Comprobar faltantes de destilados en barra",
                            "Revisar carga de neveras a tope",
                            "Revisar cambio en caja de cobro"
                        ]
                    },
                    {
                        title: "Cierre Barra Principal", category: "Cierre", area: "Barra Principal", type: "standard",
                        tasks: [
                            "Neveras cargadas A TOPE (Sin excepciones)",
                            "Limpieza absoluta de todas las superficies y raíles",
                            "Vaciar TODAS las basuras y lavar cubos",
                            "Limpieza profunda de hieleras y drenajes",
                            "Suelo barrido y fregado con desengrasante",
                            "Organizar botellería por familias",
                            "Máquinas (Café/Hielo) limpias y drenadas",
                            "Dejar todo absolutamente limpio",
                            "Reporte de incidencias y mermas enviado",
                            "Equipos no críticos en OFF"
                        ]
                    },
                    {
                        title: "Apertura Barra Secundaria", category: "Apertura", area: "Barra Secundaria", type: "standard",
                        tasks: [
                            "Colocar cristalería en hielo",
                            "Montar estación de servicio completa",
                            "Comprobar stock de premix y decoración",
                            "Rellenar stock de hielos",
                            "Vaciar basuras antes del servicio",
                            "Verificar que neveras estén a tope"
                        ]
                    },
                    {
                        title: "Cierre Barra Secundaria", category: "Cierre", area: "Barra Secundaria", type: "standard",
                        tasks: [
                            "Neveras cargadas A TOPE",
                            "Limpieza absoluta de superficies",
                            "Vaciar basuras y lavar cubos",
                            "Limpieza de drenajes y hieleras",
                            "Suelo fregado y todo absolutamente limpio",
                            "Organizar botellas y stock"
                        ]
                    },
                    {
                        title: "Apertura Lab Fenómeno", category: "Apertura", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Revisar inventario de preps al comenzar turno",
                            "Identificar preparaciones críticas según falta",
                            "Verificar maquinaria (Sous-vide, vacío, etc)",
                            "Sanitización total de zona de trabajo"
                        ]
                    },
                    {
                        title: "Producción Lab (3L - 5L)", category: "Producción", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Producción de lotes grandes (3L a 5L por cóctel)",
                            "Seguir recetas al pie de la letra (Extremo Cuidado)",
                            "Trabajar con extremo cuidado y rigor",
                            "Mantener limpieza profunda constante en producción",
                            "Etiquetado completo (Fecha y caducidad)",
                            "Control de calidad sensorial de cada lote"
                        ]
                    },
                    {
                        title: "Soporte Lab (Noche)", category: "Producción", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Surtir a las dos barras al instante si algo acaba",
                            "Reaccionar al instante ante roturas de stock en barra",
                            "Mantenimiento de limpieza en zona de preps",
                            "Basura botada y Lab impecable al cierre",
                            "Revisión de stock para turno de mañana"
                        ]
                    },
                    {
                        title: "Reporte de Mermas (Barra Principal)", category: "Inventario", area: "Barra Principal", type: "shrinkage",
                        tasks: ["Control exhaustivo de mermas, derrames, roturas y caducidades durante el servicio."]
                    },
                    {
                        title: "Reporte de Mermas (Barra Secundaria)", category: "Inventario", area: "Barra Secundaria", type: "shrinkage",
                        tasks: ["Control exhaustivo de mermas, derrames, roturas y caducidades durante el servicio."]
                    },
                    {
                        title: "Reporte de Mermas (Laboratorio)", category: "Inventario", area: "Laboratorio", type: "shrinkage",
                        tasks: ["Control exhaustivo de mermas, derrames, roturas y caducidades durante la producción."]
                    },
                    {
                        title: "Inventario de Producción (Preps)", category: "Inventario", area: "Laboratorio", type: "inventory", unit: "L/Ud",
                        tasks: [
                            "limon clarificado",
                            "litchy clarificado",
                            "sirope de maiz tostado",
                            "sal de huitlacoche",
                            "cortar hojas de maiz seco",
                            "agua de sandia",
                            "cortar sandias para garnish",
                            "agua enzimatica de pepino",
                            "zumo de manzana fortificado",
                            "brochetas de garnish",
                            "agua de tamarindo clarificado",
                            "velos de magi (gluten)",
                            "tintura de moras (glucosa)",
                            "mix de heirbas y orgeat",
                            "chip de hierbas",
                            "miel de ajo",
                            "vodka de trufa",
                            "tejas de merengue",
                            "mix de maracuya y rass el hanout",
                            "lamina de chocolate",
                            "milkpunch orbita",
                            "coco rayado",
                            "agua de tomate",
                            "carbonatados en sifon",
                            "espuma de queso",
                            "guayaba clarificada"
                        ]
                    },
                    {
                        title: "Inventario de Premixes", category: "Inventario", area: "Laboratorio", type: "inventory", unit: "Bolsa 700ml",
                        tasks: [
                            "origen",
                            "ruptura",
                            "antes de todo",
                            "destello",
                            "clorofila",
                            "nucleo",
                            "pulso",
                            "calma",
                            "singularidad",
                            "gravedad",
                            "orbita",
                            "eter",
                            "alma",
                            "aura",
                            "negroni",
                            "naked and famous",
                            "mai tai",
                            "dry martini",
                            "long island ice tea",
                            "Margarita clasica",
                        ]
                    },
                    {
                        title: "Inventario de Premixes", category: "Inventario", area: "Barra Principal", type: "inventory", unit: "Bolsa 700ml",
                        tasks: LAB_PREMIXES
                    },
                    {
                        title: "Inventario de Destilados", category: "Inventario", area: "Barra Principal", type: "inventory", unit: "Botella",
                        tasks: BOTELLAS_STOCK
                    },
                    {
                        title: "Inventario de Premixes", category: "Inventario", area: "Barra Secundaria", type: "inventory", unit: "Bolsa 700ml",
                        tasks: LAB_PREMIXES
                    },
                    {
                        title: "Inventario de Destilados", category: "Inventario", area: "Barra Secundaria", type: "inventory", unit: "Botella",
                        tasks: BOTELLAS_STOCK
                    },
                    {
                        title: "Cierre Lab Fenómeno", category: "Cierre", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Vaciar basuras y dejar todo absolutamente limpio",
                            "Lavar cubos de basura del laboratorio",
                            "Neveras del Lab cargadas A TOPE para mañana",
                            "Apagado de maquinaria de producción",
                            "Laboratorio sanitizado para el siguiente turno"
                        ]
                    }
                ];
                for (const list of defaultLists) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklists'), {
                        ...list,
                        type: list.type || 'standard'
                    });
                }

                const qConfig = collection(db, 'artifacts', appId, 'public', 'data', 'config');
                await setDoc(doc(qConfig, 'weeklySchedule'), {
                    text: `LIAN: x / 16-00 / 17-01 / 20-04 / 20-04 / 17-01 / x\n` +
                        `DILAN: 18-02 / x / x / 17-01 / 17-01 / 18-02 / 18-02\n` +
                        `DANIEL: 17-01 / 16-00 / x / x / 16-00 / 17-01 / 16-02\n` +
                        `ANTON: 19-03 / 19-03 / x / 20-04 / 20-04 / x / 19-03\n` +
                        `MARIO: 17-01 / 17-01 / x / x / 17-01 / x / 17-01\n` +
                        `GABRI: x / x / 19-03 / 19-03 / 20-04 / 20-04 / 19-03\n` +
                        `LAURA: 19-03 / x / 19-03 / 19-03 / 19-03 / 19-03 / x\n` +
                        `DIANET: x / x / 19-03 / 19-03 / 19-03 / 19-03 / 19-03\n` +
                        `LORENZO: x / 19-03 / 17-01 / 20-04 / 20-04 / 19-03 / x`
                });

                await setDoc(doc(qConfig, 'dailyLabPlan'), {
                    selections: [
                        { name: "Margarita spicy", qty: "2 bolsas 700ml" },
                        { name: "Margarita clasica", qty: "2 bolsas 700ml" },
                        { name: "long island ice tea", qty: "2 bolsas 700ml" }
                    ],
                    updatedAt: Date.now()
                });
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-zinc-950">
                    <div className="flex flex-col items-center gap-6">
                        <div className="w-16 h-16 border-4 border-amber-500/20 border-t-amber-500 rounded-full animate-spin"></div>
                        <p className="text-zinc-500 text-xs font-black tracking-[0.3em] uppercase">Fenómeno Bar Ops...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-zinc-950">
                    <nav className="sticky top-0 z-50 border-b border-zinc-800 bg-zinc-950/80 backdrop-blur-xl px-4 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-amber-500 p-1.5 rounded-lg shadow-lg">
                                <Icon name="flask-conical" size={18} className="text-zinc-950" />
                            </div>
                            <h1 className="font-black text-xl tracking-tighter uppercase italic text-white leading-none tracking-widest">FENÓMENO</h1>
                        </div>
                        <div className="flex gap-1.5 bg-zinc-900 p-1 rounded-full border border-zinc-800">
                            <button onClick={() => setView('user')} className={`px-4 py-2 rounded-full text-[9px] font-black tracking-widest transition-all ${view === 'user' ? 'bg-zinc-700 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}>BARTENDERS</button>
                            <button onClick={() => {
                                if (isAdminAuthenticated) setView('admin');
                                else setView('pin');
                            }} className={`px-4 py-2 rounded-full text-[9px] font-black tracking-widest transition-all ${view === 'admin' || view === 'pin' ? 'bg-amber-500 text-zinc-950' : 'text-zinc-500 hover:text-zinc-300'}`}>MANAGER</button>
                        </div>
                    </nav>

                    <main className="max-w-2xl mx-auto p-4 pb-24 animate-in">
                        {view === 'user' ? (
                            activeChecklist ? (
                                <ChecklistForm checklist={activeChecklist} onCancel={() => setActiveChecklist(null)} />
                            ) : (
                                <UserDashboard checklists={checklists} onSelect={setActiveChecklist} activeTab={userActiveTab} setActiveTab={setUserActiveTab} />
                            )
                        ) : view === 'pin' ? (
                            <PinEntry onSuccess={() => { setIsAdminAuthenticated(true); setView('admin'); }} onCancel={() => setView('user')} />
                        ) : (
                            <AdminPanel checklists={checklists} submissions={submissions} />
                        )}
                    </main>
                </div>
            );
        }

        const LAB_PREPS = [
            "limon clarificado", "litchy clarificado", "sirope de maiz tostado", "sal de huitlacoche",
            "cortar hojas de maiz seco", "agua de sandia", "cortar sandias para garnish", "agua enzimatica de pepino",
            "zumo de manzana fortificado", "brochetas de garnish", "agua de tamarindo clarificado",
            "velos de magi (gluten)", "tintura de moras (glucosa)", "mix de heirbas y orgeat", "chip de hierbas",
            "miel de ajo", "vodka de trufa", "tejas de merengue", "mix de maracuya y rass el hanout",
            "lamina de chocolate", "milkpunch orbita", "coco rayado", "agua de tomate", "carbonatados en sifon",
            "espuma de queso", "guayaba clarificada"
        ];
        const LAB_PREMIXES = [
            "origen", "ruptura", "antes de todo", "destello", "clorofila", "nucleo", "pulso", "calma",
            "singularidad", "gravedad", "orbita", "eter", "alma", "aura", "negroni", "naked and famous",
            "mai tai", "dry martini", "long island ice tea", "Margarita clasica", "Margarita spicy"
        ];

        const BOTELLAS_STOCK = [
            "BACARDI", "ST TERESA 1796", "DIPLOMATICO", "PLANTERAY 3 STARS",
            "1800 SILVER", "1800 CRISTALINO", "PATRON SILVER", "PATRON CRISTALINO",
            "MAESTRO DOBEL DIAMANTE", "DEOBEL 50", "DJ 1942",
            "JW BLACK LABEL", "JW GOLD LABEL", "JW BLUE LABEL",
            "HIBIKI", "YAMASAKI", "WOODFORD RESERVE",
            "GLENFIDICH 12", "GLENFIDICH 15", "LAGAVULLING 16", "LAPHROAIG 10",
            "BOMBAY SAPHIRE", "BOMBAY PRESSE", "BOMBAY PREMIER CRU",
            "TANQUERAY", "TANQUERAY TEN", "GINMARE", "SIPSMITH", "SEAGRAMS"
        ];

        // --- COMPONENTES DE USUARIO ---

        function UserDashboard({ checklists, onSelect, activeTab, setActiveTab }) {
            const [smartInventoryData, setSmartInventoryData] = useState(null);

            const [weeklySchedule, setWeeklySchedule] = useState('');
            const [dailyLabPlan, setDailyLabPlan] = useState([]);

            const [isLabModalOpen, setIsLabModalOpen] = useState(false);
            const [isScheduleExpanded, setIsScheduleExpanded] = useState(false);
            const [labSubTab, setLabSubTab] = useState('tareas');
            const [barraPrincipalSubTab, setBarraPrincipalSubTab] = useState('checklists');
            const [barraSecundariaSubTab, setBarraSecundariaSubTab] = useState('checklists');

            const parseScheduleToTable = (text) => {
                if (!text) return null;
                const lines = text.trim().split('\n');
                const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

                return (
                    <div className="w-full overflow-x-auto mt-3 border border-zinc-800/50 rounded-2xl bg-zinc-950/30">
                        <table className="w-full text-left border-collapse min-w-[450px]">
                            <thead>
                                <tr className="border-b border-zinc-800 bg-zinc-900/30">
                                    <th className="py-3 px-4 text-zinc-500 font-black uppercase text-[10px] tracking-widest">Staff</th>
                                    {days.map(d => <th key={d} className="py-3 px-2 text-zinc-500 font-black uppercase text-[10px] tracking-widest text-center w-12">{d}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {lines.map((line, idx) => {
                                    if (!line.includes(':')) return null;
                                    const [name, shiftsStr] = line.split(':');
                                    if (!name || !shiftsStr) return null;
                                    const shifts = shiftsStr.trim().split('/');
                                    return (
                                        <tr key={idx} className="border-b border-zinc-800/30 hover:bg-zinc-800/20 transition-colors last:border-0">
                                            <td className="py-3 px-4 text-white font-bold text-xs uppercase tracking-wider">{name.trim()}</td>
                                            {shifts.map((shift, i) => (
                                                <td key={i} className="py-2 px-1 text-center">
                                                    {shift.trim().toLowerCase() === 'x' ? (
                                                        <span className="bg-emerald-500/10 border border-emerald-500/20 rounded-md block w-full h-[22px] shadow-sm"></span>
                                                    ) : (
                                                        <span className="bg-amber-500/10 text-amber-500 border border-amber-500/20 px-1.5 py-1 rounded-md text-[9px] font-black tracking-widest whitespace-nowrap block w-full shadow-sm">{shift.trim()}</span>
                                                    )}
                                                </td>
                                            ))}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            };

            useEffect(() => {
                // 1. Fetch Smart Global Inventory (Static query, runs on mount)
                const fetchInventory = async () => {
                    try {
                        const qInv = window.FB.query(
                            window.FB.collection(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'submissions')
                        );
                        const snapInv = await window.FB.getDocs(qInv);
                        const recent = snapInv.docs.map(d => d.data());
                        const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
                        const validInv = recent.filter(r => r.checklistType === 'inventory' && r.timestamp > oneDayAgo);

                        if (validInv.length > 0) {
                            validInv.sort((a, b) => b.timestamp - a.timestamp);
                            const latestInventories = {};
                            validInv.forEach(inv => {
                                if (!latestInventories[inv.checklistTitle]) {
                                    latestInventories[inv.checklistTitle] = inv;
                                }
                            });
                            setSmartInventoryData(Object.values(latestInventories));
                        }
                    } catch (e) { console.error("Could not fetch inventory data", e); }
                };
                fetchInventory();

                // 2. Listen to Planning Configurations in Real-time
                const qConf = window.FB.query(
                    window.FB.collection(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config')
                );

                const unsubscribeConf = window.FB.onSnapshot(qConf, (snapshot) => {
                    let newWeeklySchedule = '';
                    let newDailyLabPlan = [];

                    snapshot.forEach(d => {
                        if (d.id === 'weeklySchedule') newWeeklySchedule = d.data().text || '';
                        if (d.id === 'dailyLabPlan') newDailyLabPlan = d.data().selections || [];
                    });

                    setWeeklySchedule(newWeeklySchedule);
                    setDailyLabPlan(newDailyLabPlan);
                }, (error) => {
                    console.error("Error listening to config updates:", error);
                });

                return () => unsubscribeConf();
            }, []);



            const areaChecklists = checklists
                .filter(c => (c.area || 'Barra Principal') === activeTab)
                .sort((a, b) => {
                    const order = { 'Apertura': 1, 'Producción': 2, 'Inventario': 3, 'Cierre': 4 };
                    return (order[a.category] || 9) - (order[b.category] || 9);
                });

            const filteredAreaChecklists = areaChecklists.filter(c => {
                if (activeTab === 'Laboratorio') {
                    if (labSubTab === 'tareas') return c.category === 'Producción' && c.title.startsWith('Producción Lab');
                    if (labSubTab === 'checklists') return (c.category !== 'Producción' || !c.title.startsWith('Producción Lab')) && c.type !== 'inventory' && c.type !== 'shrinkage';
                    if (labSubTab === 'inventarios') return c.type === 'inventory';
                    if (labSubTab === 'mermas') return false; // Handled separately
                } else if (activeTab === 'Barra Principal') {
                    if (barraPrincipalSubTab === 'checklists') return c.type !== 'inventory' && c.type !== 'shrinkage';
                    if (barraPrincipalSubTab === 'inventarios') return c.type === 'inventory';
                    if (barraPrincipalSubTab === 'mermas') return false; // Handled separately
                } else if (activeTab === 'Barra Secundaria') {
                    if (barraSecundariaSubTab === 'checklists') return c.type !== 'inventory' && c.type !== 'shrinkage';
                    if (barraSecundariaSubTab === 'inventarios') return c.type === 'inventory';
                    if (barraSecundariaSubTab === 'mermas') return false; // Handled separately
                }
                return true;
            });

            return (
                <div className="space-y-8 mt-4 animate-in">
                    <header className="mb-8">
                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none text-white tracking-widest animate-in">Operativa<br /><span className="text-amber-500 italic">FENÓMENO</span></h2>
                    </header>

                    <div className="flex gap-10 border-b border-zinc-800 mb-8 overflow-x-auto scrollbar-hide no-print">
                        <button onClick={() => setActiveTab('resumen')} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'resumen' ? 'text-white' : 'text-zinc-600'}`}><span>Resumen</span> {activeTab === 'resumen' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('Barra Principal'); setBarraPrincipalSubTab('checklists'); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'Barra Principal' ? 'text-white' : 'text-zinc-600'}`}><span>Barra Principal</span> {activeTab === 'Barra Principal' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('Barra Secundaria'); setBarraSecundariaSubTab('checklists'); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'Barra Secundaria' ? 'text-white' : 'text-zinc-600'}`}><span>Barra Secundaria</span> {activeTab === 'Barra Secundaria' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('Laboratorio'); setLabSubTab('tareas'); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'Laboratorio' ? 'text-white' : 'text-zinc-600'}`}><span>Laboratorio</span> {activeTab === 'Laboratorio' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                    </div>

                    {activeTab === 'resumen' ? (
                        <div key="tab-resumen" className="space-y-8 animate-in mt-4">
                            {(weeklySchedule || dailyLabPlan) && (
                                <div className="grid grid-cols-1 xl:grid-cols-5 gap-4">
                                    {weeklySchedule && (
                                        <div className="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-6 shadow-xl relative overflow-hidden xl:col-span-3">
                                            <div className="absolute top-0 right-0 w-48 h-48 bg-amber-500/5 rounded-full blur-3xl"></div>
                                            <div className="flex items-center justify-between mb-4 cursor-pointer group" onClick={() => setIsScheduleExpanded(!isScheduleExpanded)}>
                                                <h3 className="text-amber-500 font-black uppercase tracking-widest text-xs flex items-center gap-2"><Icon name="calendar-days" size={16} /> Horario Semanal</h3>
                                                <div className="w-8 h-8 rounded-full bg-zinc-950/50 border border-zinc-800 flex items-center justify-center group-hover:border-amber-500/30 transition-all text-zinc-500">
                                                    <Icon name={isScheduleExpanded ? 'chevron-up' : 'chevron-down'} size={14} />
                                                </div>
                                            </div>
                                            <div className={`transition-all duration-300 overflow-hidden ${isScheduleExpanded ? 'max-h-[1000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                                                {parseScheduleToTable(weeklySchedule)}
                                            </div>
                                        </div>
                                    )}
                                    {dailyLabPlan && dailyLabPlan.length > 0 && (
                                        <div className="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-6 shadow-xl relative overflow-hidden xl:col-span-2 flex flex-col group">
                                            <div className="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full blur-3xl transition-all group-hover:bg-amber-500/10"></div>
                                            <div className="mb-4">
                                                <h3 className="text-amber-500 font-black uppercase tracking-widest text-xs flex items-center gap-2 mb-2"><Icon name="test-tubes" size={16} /> Planificador Lab</h3>
                                            </div>
                                            <div className="space-y-2 overflow-y-auto max-h-[220px] scrollbar-hide mb-4 relative z-10 w-full pl-1">
                                                {dailyLabPlan.filter(p => LAB_PREMIXES.includes(p.name)).concat(dailyLabPlan.filter(p => LAB_PREPS.includes(p.name))).map(item => (
                                                    <div key={`card-${item.name}`} className="flex flex-col p-3 rounded-xl bg-zinc-950/50 border border-zinc-800/50 hover:border-amber-500/30 transition-all w-full group">
                                                        <div className="flex items-center">
                                                            <div className="w-1.5 h-1.5 rounded-full bg-amber-500 mr-3 shadow-[0_0_8px_#f59e0b] shrink-0"></div>
                                                            <span className="font-bold uppercase tracking-widest text-[10px] text-zinc-300 group-hover:text-white transition-colors flex-1">{item.name}</span>
                                                        </div>
                                                        {item.qty && <span className="ml-4 mt-2 text-[10px] text-amber-500 bg-amber-500/10 px-2 py-1 rounded-md border border-amber-500/20 self-start font-black">{item.qty}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={() => setIsLabModalOpen(true)} className="w-full bg-zinc-800 text-zinc-400 font-black uppercase tracking-widest py-3 rounded-xl hover:bg-zinc-700 hover:text-white transition-colors text-[10px] shadow-lg mt-auto flex items-center justify-center gap-2 relative z-10 shrink-0">
                                                <Icon name="maximize-2" size={14} /> Expandir Vista Lab
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {smartInventoryData && smartInventoryData.length > 0 && (
                                <div className="bg-gradient-to-br from-zinc-900 border border-zinc-800 rounded-3xl p-6 shadow-xl relative overflow-hidden group">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Icon name="clipboard-check" className="text-zinc-500" size={18} />
                                        <h3 className="text-zinc-500 font-black uppercase tracking-widest text-xs">Inventarios Activos (Últimas 24h)</h3>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto pr-2 scrollbar-hide pb-2">
                                        {smartInventoryData.map((invData, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => setSmartInventoryData(prev => prev.map((item, id) => id === idx ? { ...item, _expanded: !item._expanded } : item))}
                                                className="w-full text-left bg-zinc-950 p-5 rounded-3xl border border-zinc-800 hover:border-amber-500/30 transition-all flex flex-col justify-start relative cursor-pointer group/card h-fit"
                                            >
                                                <div className="flex justify-between items-center w-full">
                                                    <div>
                                                        <p className="text-white font-black text-sm tracking-tight uppercase group-hover/card:text-amber-500 transition-colors">{invData.checklistTitle}</p>
                                                        <p className="text-[10px] text-zinc-500 font-black uppercase tracking-widest mt-0.5">{new Date(invData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                                    </div>
                                                    <div className="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center group-hover/card:border-amber-500/30 transition-all shadow-lg shrink-0">
                                                        <Icon name={invData._expanded ? "chevron-up" : "chevron-down"} size={16} className={`${invData._expanded ? "text-amber-500" : "text-zinc-500"} transition-all`} />
                                                    </div>
                                                </div>

                                                {invData._expanded && (
                                                    <div className="flex flex-wrap gap-2 mt-4 pt-4 border-t border-zinc-800/50 w-full animate-in fade-in slide-in-from-top-2 duration-200">
                                                        {invData.tasks.map((t, i) => {
                                                            const val = invData.inventoryValues?.[i] || 0;
                                                            if (val === 0 || val === "0") return null;
                                                            return (
                                                                <span key={i} className="text-[10px] bg-zinc-900 border border-zinc-800 text-zinc-400 font-black px-2 py-1.5 rounded-lg uppercase flex items-center shadow-sm">
                                                                    {t.split('(')[0].trim()} <span className="ml-2 text-amber-500 bg-amber-500/10 px-1.5 py-0.5 rounded-md border border-amber-500/20">{val}</span>
                                                                </span>
                                                            )
                                                        })}
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-4 pb-4">
                                <button onClick={() => { setActiveTab('Barra Principal'); setBarraPrincipalSubTab('checklists'); }} className="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-5 shadow-xl flex flex-col items-center justify-center gap-3 hover:border-amber-500/50 hover:bg-zinc-800 transition-all text-zinc-400 hover:text-white group">
                                    <div className="w-12 h-12 rounded-full bg-zinc-950 flex items-center justify-center shadow-inner group-hover:text-amber-500 transition-colors"><Icon name="list-checks" size={20} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-widest text-center">Ir a Checklists</span>
                                </button>
                                <button onClick={() => { setActiveTab('Barra Principal'); setBarraPrincipalSubTab('mermas'); }} className="bg-zinc-900/80 border border-zinc-800 rounded-3xl p-5 shadow-xl flex flex-col items-center justify-center gap-3 hover:border-red-500/50 hover:bg-zinc-800 transition-all text-zinc-400 hover:text-white group">
                                    <div className="w-12 h-12 rounded-full bg-zinc-950 flex items-center justify-center shadow-inner group-hover:text-red-500 transition-colors"><Icon name="alert-triangle" size={20} /></div>
                                    <span className="text-[10px] font-black uppercase tracking-widest text-center">Reportar Merma</span>
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div key="tab-checklists" className="grid gap-3 animate-in mt-4">
                            {activeTab === 'Laboratorio' && (
                                <div className="flex gap-2 p-1.5 bg-zinc-900 border border-zinc-800 rounded-2xl mb-4 overflow-x-auto scrollbar-hide no-print">
                                    <button onClick={() => setLabSubTab('tareas')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${labSubTab === 'tareas' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="clipboard-check" size={14} /> Tareas de Hoy</button>
                                    <button onClick={() => setLabSubTab('checklists')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${labSubTab === 'checklists' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="list-checks" size={14} /> Checklists</button>
                                    <button onClick={() => setLabSubTab('inventarios')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${labSubTab === 'inventarios' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="boxes" size={14} /> Inventarios</button>
                                    <button onClick={() => setLabSubTab('mermas')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${labSubTab === 'mermas' ? 'bg-red-500 text-white shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="alert-triangle" size={14} /> Mermas</button>
                                </div>
                            )}
                            {activeTab === 'Barra Principal' && (
                                <div className="flex gap-2 p-1.5 bg-zinc-900 border border-zinc-800 rounded-2xl mb-4 overflow-x-auto scrollbar-hide no-print">
                                    <button onClick={() => setBarraPrincipalSubTab('checklists')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraPrincipalSubTab === 'checklists' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="list-checks" size={14} /> Checklists</button>
                                    <button onClick={() => setBarraPrincipalSubTab('inventarios')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraPrincipalSubTab === 'inventarios' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="clipboard-list" size={14} /> Inventarios</button>
                                    <button onClick={() => setBarraPrincipalSubTab('mermas')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraPrincipalSubTab === 'mermas' ? 'bg-red-500 text-white shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="alert-triangle" size={14} /> Mermas</button>
                                </div>
                            )}
                            {activeTab === 'Barra Secundaria' && (
                                <div className="flex gap-2 p-1.5 bg-zinc-900 border border-zinc-800 rounded-2xl mb-4 overflow-x-auto scrollbar-hide no-print">
                                    <button onClick={() => setBarraSecundariaSubTab('checklists')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraSecundariaSubTab === 'checklists' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="list-checks" size={14} /> Checklists</button>
                                    <button onClick={() => setBarraSecundariaSubTab('inventarios')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraSecundariaSubTab === 'inventarios' ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="clipboard-list" size={14} /> Inventarios</button>
                                    <button onClick={() => setBarraSecundariaSubTab('mermas')} className={`flex-1 py-3 px-4 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center justify-center gap-2 ${barraSecundariaSubTab === 'mermas' ? 'bg-red-500 text-white shadow-lg' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}`}><Icon name="alert-triangle" size={14} /> Mermas</button>
                                </div>
                            )}

                            {((activeTab === 'Barra Principal' && barraPrincipalSubTab === 'mermas') || (activeTab === 'Barra Secundaria' && barraSecundariaSubTab === 'mermas') || (activeTab === 'Laboratorio' && labSubTab === 'mermas')) ? (
                                <div className="animate-in mt-4">
                                    <ChecklistForm
                                        checklist={{ id: `mermas-${activeTab}`, title: `Reporte de Mermas (${activeTab})`, type: 'shrinkage', category: 'Inventario', area: activeTab, tasks: [] }}
                                        onCancel={() => activeTab === 'Barra Principal' ? setBarraPrincipalSubTab('checklists') : activeTab === 'Barra Secundaria' ? setBarraSecundariaSubTab('checklists') : setLabSubTab('tareas')}
                                    />
                                </div>
                            ) : filteredAreaChecklists.length === 0 ? (
                                <div className="p-8 text-center border-2 border-dashed border-zinc-800 rounded-3xl text-zinc-600 font-bold uppercase tracking-widest text-xs">Aún no hay listas en esta área</div>
                            ) : (
                                filteredAreaChecklists.map(item => (
                                    <button key={item.id} onClick={() => onSelect(item)} className="w-full flex items-center justify-between p-6 bg-zinc-900/40 border border-zinc-800 rounded-[2.5rem] active:scale-95 transition-all group hover:border-amber-500/30">
                                        <div className="flex items-center gap-5 text-left">
                                            <div className="w-12 h-12 rounded-2xl bg-zinc-800 flex items-center justify-center text-zinc-400 group-hover:bg-amber-500 group-hover:text-zinc-950 transition-all duration-300">
                                                <Icon name={item.category === 'Apertura' ? 'sun' : item.category === 'Cierre' ? 'moon' : item.type === 'inventory' ? 'clipboard-list' : 'beaker'} size={24} />
                                            </div>
                                            <div>
                                                <p className="font-black text-lg uppercase tracking-tight leading-tight text-white">{item.title}</p>
                                                <p className="text-zinc-600 text-[10px] font-black uppercase tracking-widest mt-1 italic">{item.type === 'inventory' ? 'Inventario' : 'Checklist'} ({item.category}) • {item.tasks.length} {item.type === 'inventory' ? 'Ítems' : 'Tareas'}</p>
                                            </div>
                                        </div>
                                        <Icon name="chevron-right" className="text-zinc-700" />
                                    </button>
                                ))
                            )}
                        </div>
                    )}
                    {isLabModalOpen && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-md z-50 overflow-y-auto w-full h-full animate-in fade-in flex flex-col">
                            <div className="sticky top-0 bg-zinc-950/90 backdrop-blur-xl border-b border-zinc-800 p-4 sm:p-6 flex items-center justify-between z-10 shadow-2xl">
                                <div>
                                    <h2 className="text-2xl font-black uppercase tracking-tighter text-amber-500 flex items-center gap-3"><Icon name="test-tubes" size={24} /> Plan de Producción</h2>
                                    <p className="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Control Diario de Laboratorio</p>
                                </div>
                                <button onClick={() => setIsLabModalOpen(false)} className="w-12 h-12 bg-zinc-900 border border-zinc-800 rounded-full flex items-center justify-center text-zinc-400 hover:text-white hover:border-amber-500 hover:bg-amber-500/10 transition-all shadow-lg group">
                                    <Icon name="x" size={24} className="group-hover:rotate-90 transition-transform duration-300" />
                                </button>
                            </div>
                            <div className="p-4 sm:p-8 flex-1 max-w-7xl mx-auto w-full">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12 mt-4">
                                    <div className="space-y-6">
                                        <div className="flex items-center gap-3 border-b-2 border-zinc-800 pb-4 mb-2">
                                            <div className="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-500 border border-amber-500/20"><Icon name="flask-conical" size={20} /></div>
                                            <h3 className="text-white font-black uppercase text-xl tracking-wide">Premixes Asignados</h3>
                                        </div>
                                        <div className="grid grid-cols-1 gap-2">
                                            {dailyLabPlan.filter(p => LAB_PREMIXES.includes(p.name)).length === 0 ? (
                                                <div className="p-6 text-center border border-dashed border-zinc-800 rounded-2xl text-zinc-500 font-bold uppercase tracking-widest text-xs">No hay premixes planeados hoy</div>
                                            ) : (
                                                dailyLabPlan.filter(p => LAB_PREMIXES.includes(p.name)).map(item => (
                                                    <div key={`premix-${item.name}`} className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-4 rounded-2xl bg-zinc-900/30 border border-zinc-800/50 hover:bg-zinc-800/80 transition-all group">
                                                        <div className="flex items-center">
                                                            <div className="w-2 h-2 rounded-full bg-amber-500 mr-4 shadow-[0_0_8px_#f59e0b] shrink-0"></div>
                                                            <span className="font-bold uppercase tracking-widest text-xs text-zinc-300 group-hover:text-white transition-colors">{item.name}</span>
                                                        </div>
                                                        {item.qty && <span className="text-[10px] text-amber-500 bg-amber-500/10 px-3 py-1.5 rounded-md border border-amber-500/20 sm:self-auto self-start ml-6 sm:ml-0 font-black">{item.qty}</span>}
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                    <div className="space-y-6">
                                        <div className="flex items-center gap-3 border-b-2 border-zinc-800 pb-4 mb-2">
                                            <div className="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-500 border border-amber-500/20"><Icon name="test-tube-2" size={20} /></div>
                                            <h3 className="text-white font-black uppercase text-xl tracking-wide">Preparaciones Asignadas</h3>
                                        </div>
                                        <div className="grid grid-cols-1 gap-2">
                                            {dailyLabPlan.filter(p => LAB_PREPS.includes(p.name)).length === 0 ? (
                                                <div className="p-6 text-center border border-dashed border-zinc-800 rounded-2xl text-zinc-500 font-bold uppercase tracking-widest text-xs">No hay preparaciones planeadas hoy</div>
                                            ) : (
                                                dailyLabPlan.filter(p => LAB_PREPS.includes(p.name)).map(item => (
                                                    <div key={`prep-${item.name}`} className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-4 rounded-2xl bg-zinc-900/30 border border-zinc-800/50 hover:bg-zinc-800/80 transition-all group">
                                                        <div className="flex items-center">
                                                            <div className="w-2 h-2 rounded-full bg-amber-500 mr-4 shadow-[0_0_8px_#f59e0b] shrink-0"></div>
                                                            <span className="font-bold uppercase tracking-widest text-xs text-zinc-300 group-hover:text-white transition-colors">{item.name}</span>
                                                        </div>
                                                        {item.qty && <span className="text-[10px] text-amber-500 bg-amber-500/10 px-3 py-1.5 rounded-md border border-amber-500/20 sm:self-auto self-start ml-6 sm:ml-0 font-black">{item.qty}</span>}
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        function ChecklistForm({ checklist, onCancel }) {
            const [completed, setCompleted] = useState([]);
            const [inventoryValues, setInventoryValues] = useState({});
            const [shrinkageRecords, setShrinkageRecords] = useState([]);
            const [newShrinkage, setNewShrinkage] = useState({ product: '', qty: '', unit: 'Lt', reason: 'Error de preparación', disposal: 'Desechado' });
            const [shrinkageArea, setShrinkageArea] = useState(checklist.area || 'Barra Principal');
            const [bartender, setBartender] = useState('');
            const [notes, setNotes] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const { db, collection, addDoc, appId } = window.FB;

            const isInventory = checklist.type === 'inventory';
            const isShrinkage = checklist.type === 'shrinkage';

            const toggle = (idx) => {
                if (isInventory || isShrinkage) return;
                setCompleted(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);
            };

            const updateInventory = (idx, value) => {
                setInventoryValues(prev => ({ ...prev, [idx]: value }));
            };

            const addShrinkageRecord = () => {
                if (!newShrinkage.product || !newShrinkage.qty) return;
                setShrinkageRecords([...shrinkageRecords, { ...newShrinkage }]);
                setNewShrinkage({ product: '', qty: '', unit: 'Lt', reason: 'Error de preparación', disposal: 'Desechado' });
            };
            const removeShrinkageRecord = (idx) => {
                setShrinkageRecords(shrinkageRecords.filter((_, i) => i !== idx));
            }

            const isValid = () => {
                if (bartender.trim() === '') return false;
                if (isShrinkage) return shrinkageRecords.length > 0;
                if (isInventory) return Object.keys(inventoryValues).length === checklist.tasks.length;
                return completed.length === checklist.tasks.length;
            };

            const submit = async () => {
                if (!isValid()) return;
                setIsSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), {
                        checklistId: checklist.id || 'unknown',
                        checklistTitle: checklist.title || 'Checklist',
                        checklistType: checklist.type || 'standard',
                        area: isShrinkage ? shrinkageArea : (checklist.area || 'General'),
                        category: checklist.category || 'Otros',
                        bartender: bartender || '',
                        notes: notes || '',
                        completedIndices: completed || [],
                        inventoryValues: inventoryValues || {},
                        shrinkageRecords: shrinkageRecords || [],
                        tasks: checklist.tasks || [],
                        timestamp: Date.now()
                    });
                    onCancel();
                } catch (e) {
                    console.error("Error", e);
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="space-y-6 animate-in">
                    <button onClick={onCancel} className="flex items-center gap-2 text-zinc-500 hover:text-white font-black text-[10px] uppercase tracking-widest transition-colors mb-4 border border-zinc-800 rounded-xl px-4 py-2 bg-zinc-950/50">
                        <Icon name="arrow-left" size={14} /> Volver
                    </button>

                    <div className="bg-[#1A1A1A] border-2 border-[#2A2A2A] rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden group">
                        <div className="absolute inset-0 bg-gradient-to-br from-[#2A2A2A]/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-1000 pointer-events-none"></div>
                        <h3 className="text-3xl font-black uppercase tracking-tighter text-white mb-2 leading-none relative z-10">{checklist.title}</h3>
                        <p className="text-[#888888] text-[10px] font-black uppercase tracking-[0.2em] relative z-10 flex items-center gap-2">
                            <span>{checklist.category}</span>
                            <span className="w-1 h-1 rounded-full bg-amber-500"></span>
                            <span>{isShrinkage ? shrinkageArea : (checklist.area || 'Barra Principal')}</span>
                        </p>
                    </div>

                    {!isInventory && !isShrinkage && (
                        <div className="w-full bg-zinc-900 rounded-full h-2 mb-6 overflow-hidden shadow-inner">
                            <div className="bg-amber-500 h-2 rounded-full transition-all duration-500 shadow-[0_0_10px_#f59e0b]" style={{ width: `${(completed.length / checklist.tasks.length) * 100}%` }}></div>
                        </div>
                    )}

                    <div className="space-y-3">
                        {isShrinkage ? (
                            <div className="bg-zinc-900/50 border-2 border-zinc-800 rounded-[2.5rem] p-6 space-y-6">
                                <div className="space-y-3">
                                    <p className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">¿En qué zona ocurrió?</p>
                                    <div className="flex flex-col md:flex-row gap-2">
                                        <button onClick={() => setShrinkageArea('Barra Principal')} className={`flex-1 py-3 px-2 rounded-xl border font-black text-[10px] uppercase tracking-widest transition-all ${shrinkageArea === 'Barra Principal' ? 'bg-amber-500 text-zinc-950 border-amber-500 shadow-lg' : 'bg-zinc-950 border-zinc-800 text-zinc-500 hover:border-amber-500/30 hover:text-white'}`}>Barra Principal</button>
                                        <button onClick={() => setShrinkageArea('Barra Secundaria')} className={`flex-1 py-3 px-2 rounded-xl border font-black text-[10px] uppercase tracking-widest transition-all ${shrinkageArea === 'Barra Secundaria' ? 'bg-amber-500 text-zinc-950 border-amber-500 shadow-lg' : 'bg-zinc-950 border-zinc-800 text-zinc-500 hover:border-amber-500/30 hover:text-white'}`}>Barra Sec.</button>
                                        <button onClick={() => setShrinkageArea('Laboratorio')} className={`flex-1 py-3 px-2 rounded-xl border font-black text-[10px] uppercase tracking-widest transition-all ${shrinkageArea === 'Laboratorio' ? 'bg-amber-500 text-zinc-950 border-amber-500 shadow-lg' : 'bg-zinc-950 border-zinc-800 text-zinc-500 hover:border-amber-500/30 hover:text-white'}`}>Laboratorio</button>
                                    </div>
                                </div>
                                <div className="h-px w-full bg-zinc-800/50"></div>
                                <p className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Añadir Nuevo Registro de Merma</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input
                                        type="text" placeholder="Producto / Ingrediente" value={newShrinkage.product} onChange={e => setNewShrinkage({ ...newShrinkage, product: e.target.value })}
                                        className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-white font-bold placeholder-zinc-600 focus:border-red-500 outline-none"
                                    />
                                    <div className="flex gap-2">
                                        <input
                                            type="number" step="0.1" placeholder="Cant." value={newShrinkage.qty} onChange={e => setNewShrinkage({ ...newShrinkage, qty: e.target.value })}
                                            className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-white font-bold focus:border-red-500 outline-none"
                                        />
                                        <select value={newShrinkage.unit} onChange={e => setNewShrinkage({ ...newShrinkage, unit: e.target.value })} className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-white font-bold focus:border-red-500 outline-none">
                                            <option>Lt</option><option>Uds</option><option>Bolsas (700ml)</option><option>Gr</option>
                                        </select>
                                    </div>
                                    <select value={newShrinkage.reason} onChange={e => setNewShrinkage({ ...newShrinkage, reason: e.target.value })} className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-white font-bold focus:border-red-500 outline-none">
                                        <option>Error de preparación</option><option>Rotura</option><option>Caducidad/Deterioro</option><option>Invitación/Cortesía</option><option>Comanda repetida</option><option>El cliente lo rechazó</option><option>Error de tickado</option>
                                    </select>
                                    <select value={newShrinkage.disposal} onChange={e => setNewShrinkage({ ...newShrinkage, disposal: e.target.value })} className="w-full bg-zinc-950 border border-zinc-800 rounded-xl p-4 text-white font-bold focus:border-red-500 outline-none">
                                        <option>Desechado</option><option>Reaprovechado/Rework</option>
                                    </select>
                                </div>
                                <button onClick={addShrinkageRecord} className="w-full bg-red-500/10 text-red-500 border border-red-500/30 p-4 rounded-xl font-black uppercase tracking-widest text-xs hover:bg-red-500 hover:text-white transition-all">Añadir Registro</button>

                                {shrinkageRecords.length > 0 && (
                                    <div className="pt-6 mt-6 border-t border-zinc-800 space-y-2">
                                        <h4 className="text-white text-xs font-black uppercase mb-4">Registros Actuales ({shrinkageRecords.length})</h4>
                                        {shrinkageRecords.map((rec, i) => (
                                            <div key={i} className="flex justify-between items-center bg-zinc-950 p-4 rounded-xl border border-zinc-800">
                                                <div>
                                                    <p className="text-white font-bold text-sm tracking-tight">{rec.product} <span className="text-red-500">- {rec.qty} {rec.unit}</span></p>
                                                    <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest leading-tight">{rec.reason} • {rec.disposal}</p>
                                                </div>
                                                <button onClick={() => removeShrinkageRecord(i)} className="text-zinc-600 hover:text-red-500 p-2"><Icon name="trash-2" size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ) : (
                            checklist.tasks.map((task, idx) => (
                                isInventory ? (
                                    <div key={idx} className={`p-5 rounded-[1.5rem] border-2 transition-all flex items-center gap-5 ${inventoryValues[idx] ? 'bg-amber-500/5 border-amber-500/30' : 'bg-zinc-900/50 border-zinc-800'}`}>
                                        <div className="flex-1 font-bold text-sm tracking-tight leading-tight uppercase text-white">{task} <span className="text-zinc-500 text-[10px] tracking-widest block mt-1">{checklist.unit || "UDS"}</span></div>
                                        <input
                                            type="number"
                                            step="0.1"
                                            min="0"
                                            placeholder="0"
                                            value={inventoryValues[idx] || ""}
                                            onChange={e => updateInventory(idx, e.target.value)}
                                            className="w-20 bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-center text-white font-black uppercase focus:border-amber-500 outline-none shadow-inner"
                                        />
                                    </div>
                                ) : (
                                    <div key={idx} onClick={() => toggle(idx)} className={`p-6 rounded-[1.5rem] border-2 transition-all flex items-start gap-5 cursor-pointer active:scale-[0.98] ${completed.includes(idx) ? 'bg-amber-500/5 border-amber-500/30 text-white shadow-lg' : 'bg-zinc-900/50 border-zinc-800 text-zinc-600 hover:border-zinc-700'}`}>
                                        <div className={`w-8 h-8 rounded-xl border-2 flex-shrink-0 flex items-center justify-center transition-all ${completed.includes(idx) ? 'bg-amber-500 border-amber-500 shadow-lg shadow-amber-500/20' : 'border-zinc-800 bg-zinc-950'}`}>
                                            {completed.includes(idx) && <Icon name="check" size={18} className="text-zinc-950 font-black" />}
                                        </div>
                                        <span className={`font-bold text-base tracking-tight leading-tight pt-1 uppercase ${completed.includes(idx) ? 'text-white' : 'text-zinc-500'}`}>{task}</span>
                                    </div>
                                )
                            ))
                        )}
                    </div>

                    <div className="bg-zinc-900 p-8 rounded-[2.5rem] border border-zinc-800 space-y-6 shadow-xl">
                        <input type="text" placeholder="TU NOMBRE" className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={bartender} onChange={e => setBartender(e.target.value)} />
                        <textarea placeholder="INCIDENCIAS / MERMAS / STOCK..." className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white text-sm focus:ring-2 focus:ring-amber-500 outline-none" rows="3" value={notes} onChange={e => setNotes(e.target.value)} />
                    </div>
                    <button
                        onClick={submit}
                        disabled={!isValid() || isSubmitting}
                        className={`w-full p-6 text-center rounded-[2rem] font-black text-xl tracking-tight transition-all active:scale-[0.98]
                                ${isValid() ? (isShrinkage ? 'bg-red-500 text-white shadow-[0_10px_40px_-10px_rgba(239,68,68,0.5)]' : 'bg-white text-black shadow-[0_10px_40px_-10px_rgba(255,255,255,0.3)]') : 'bg-zinc-900 text-zinc-600 border border-zinc-800'}`}
                    >
                        {isSubmitting ? 'Enviando Reporte...' : (isShrinkage ? 'Cerrar Registro de Mermas' : 'Completar Tareas')}
                    </button>
                </div >
            );
        }

        // --- PANEL DE ADMIN ---

        function PinEntry({ onSuccess, onCancel }) {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);
            const CORRECT_PIN = "2024";

            const handleSubmit = (e) => {
                e.preventDefault();
                if (pin === CORRECT_PIN) {
                    onSuccess();
                } else {
                    setError(true);
                    setPin("");
                }
            };

            return (
                <div className="flex flex-col items-center justify-center py-20 animate-in">
                    <div className="bg-zinc-900 border border-zinc-800 p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full text-center">
                        <div className="w-16 h-16 bg-zinc-800 rounded-2xl mx-auto flex items-center justify-center mb-6 text-amber-500">
                            <Icon name="lock" size={32} />
                        </div>
                        <h2 className="text-2xl font-black uppercase text-white tracking-widest mb-2">Acceso Manager</h2>
                        <p className="text-zinc-500 text-xs mb-8 uppercase tracking-widest">Introduce tu PIN</p>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="password"
                                maxLength={4}
                                value={pin}
                                onChange={(e) => { setPin(e.target.value); setError(false); }}
                                className={`w-full bg-zinc-950 border ${error ? 'border-red-500' : 'border-zinc-800'} rounded-2xl p-4 text-center text-4xl tracking-[1em] text-white focus:outline-none focus:border-amber-500 transition-colors mb-4`}
                                placeholder="••••"
                                autoFocus
                            />
                            {error && <p className="text-red-500 text-xs font-bold uppercase tracking-widest mb-4">PIN Incorrecto</p>}
                            <div className="flex gap-3 mt-4">
                                <button type="submit" className="flex-1 bg-amber-500 text-zinc-950 py-4 rounded-xl font-black uppercase tracking-widest text-xs">Entrar</button>
                                <button type="button" onClick={onCancel} className="flex-1 bg-zinc-800 text-white py-4 rounded-xl font-black uppercase tracking-widest text-xs">Atrás</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AdminPanel({ checklists, submissions }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [editingList, setEditingList] = useState(null);
            const [checklistToDelete, setChecklistToDelete] = useState(null);
            const [toastMessage, setToastMessage] = useState(null);
            const [showPdfPreview, setShowPdfPreview] = useState(false);

            const [weeklySchedule, setWeeklySchedule] = useState('');
            const [dailyLabPlan, setDailyLabPlan] = useState([]);
            const [isSavingPlanning, setIsSavingPlanning] = useState(false);

            useEffect(() => {
                if (activeTab === 'planificacion') {
                    const fetchConfig = async () => {
                        try {
                            const qS = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config', 'weeklySchedule');
                            const qL = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config', 'dailyLabPlan');

                            const [snapS, snapL] = await Promise.all([
                                window.FB.getDocs(window.FB.query(window.FB.collection(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config'))),
                            ]);

                            // Using a more manual approach since getDoc is not exported, we fetch the config collection
                            snapS.forEach(d => {
                                if (d.id === 'weeklySchedule') setWeeklySchedule(d.data().text || '');
                                if (d.id === 'dailyLabPlan') {
                                    const raw = d.data().selections || [];
                                    setDailyLabPlan(raw.map(item => typeof item === 'string' ? { name: item, qty: '' } : item));
                                }
                            });
                        } catch (e) { console.error("Could not fetch planning config", e); }
                    };
                    fetchConfig();
                }
            }, [activeTab]);

            const savePlanning = async () => {
                setIsSavingPlanning(true);
                try {
                    const docS = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config', 'weeklySchedule');
                    const docL = window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'config', 'dailyLabPlan');

                    const ops = [
                        window.FB.setDoc(docS, { text: weeklySchedule }, { merge: true }),
                        window.FB.setDoc(docL, { selections: dailyLabPlan }, { merge: true })
                    ];

                    const premixTasks = dailyLabPlan.filter(p => LAB_PREMIXES.includes(p.name)).map(p => p.qty ? `${p.name} - ${p.qty}` : p.name);
                    const prepTasks = dailyLabPlan.filter(p => LAB_PREPS.includes(p.name)).map(p => p.qty ? `${p.name} - ${p.qty}` : p.name);
                    const dateStr = new Date().toLocaleDateString();

                    if (premixTasks.length > 0) {
                        ops.push(window.FB.addDoc(window.FB.collection(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'checklists'), {
                            title: `Producción Lab (Premixes) - ${dateStr}`,
                            category: "Producción",
                            area: "Laboratorio",
                            type: "standard",
                            tasks: premixTasks,
                            createdAt: Date.now()
                        }));
                    }

                    if (prepTasks.length > 0) {
                        ops.push(window.FB.addDoc(window.FB.collection(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'checklists'), {
                            title: `Producción Lab (Preps) - ${dateStr}`,
                            category: "Producción",
                            area: "Laboratorio",
                            type: "standard",
                            tasks: prepTasks,
                            createdAt: Date.now() + 1
                        }));
                    }

                    await Promise.all(ops);
                    setToastMessage({ type: 'success', text: 'Planificación guardada con éxito' });
                } catch (e) {
                    console.error(e);
                    setToastMessage({ type: 'error', text: 'Error guardando la planificación' });
                }
                setTimeout(() => setToastMessage(null), 3000);
                setIsSavingPlanning(false);
            };

            const confirmDeletion = async () => {
                if (!checklistToDelete) return;
                try {
                    await window.FB.deleteDoc(window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'checklists', checklistToDelete));
                } catch (e) {
                    console.error("Error deleting checklist:", e);
                    alert("No se pudo eliminar el protocolo.");
                } finally {
                    setChecklistToDelete(null);
                }
            };

            // Dashboard Metrics
            const today = new Date().setHours(0, 0, 0, 0);
            const todaysSubmissions = submissions.filter(s => s.timestamp >= today);
            const totalSubmissionsToday = todaysSubmissions.length;

            const generateGroupedReport = () => {
                const grouped = {};
                todaysSubmissions.forEach(sub => {
                    const area = sub.area || 'General';
                    const category = sub.category || 'Otros';
                    if (!grouped[area]) grouped[area] = {};
                    if (!grouped[area][category]) grouped[area][category] = [];
                    grouped[area][category].push(sub);
                });
                return grouped;
            };

            const groupedReport = generateGroupedReport();

            let avgCompletion = 0;
            const standardSubmissions = todaysSubmissions.filter(s => s.checklistType !== 'inventory');
            if (standardSubmissions.length > 0) {
                const totalCompletion = standardSubmissions.reduce((acc, sub) => acc + (sub.completedIndices.length / sub.tasks.length), 0);
                avgCompletion = Math.round((totalCompletion / standardSubmissions.length) * 100);
            }

            const totalShrinkageItems = todaysSubmissions.reduce((acc, sub) => acc + (sub.shrinkageRecords ? sub.shrinkageRecords.length : 0), 0);

            // Chart Data Prep
            const areaCounts = {};
            todaysSubmissions.forEach(sub => {
                const area = sub.area || 'General';
                areaCounts[area] = (areaCounts[area] || 0) + 1;
            });
            const maxActivityArea = Math.max(...Object.values(areaCounts), 1);

            const recentActivity = [...submissions].sort((a, b) => b.timestamp - a.timestamp).slice(0, 6);
            const recentNotes = submissions.filter(s => s.observations && s.observations.trim() !== "").slice(0, 3);

            return (
                <div className="space-y-8 animate-in mt-4">
                    <header className="flex items-center justify-between no-print">
                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none text-white tracking-widest italic">Manager<br /><span className="text-amber-500 not-italic">Dashboard</span></h2>
                        <button onClick={() => { setEditingList({ title: "", category: "Apertura", tasks: [""] }); setActiveTab('manage'); }} className="bg-amber-500 text-zinc-950 px-5 py-3 rounded-2xl flex items-center gap-2 font-black text-[10px] uppercase tracking-widest shadow-xl active:scale-95 transition-all">
                            <Icon name="plus" size={16} /> Crear
                        </button>
                    </header>

                    <div className="flex gap-10 border-b border-zinc-800 mb-8 overflow-x-auto scrollbar-hide no-print">
                        <button onClick={() => { setActiveTab('overview'); setShowPdfPreview(false); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'overview' ? 'text-white' : 'text-zinc-600'}`}><span>Resumen Diario</span> {activeTab === 'overview' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('submissions'); setShowPdfPreview(false); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'submissions' ? 'text-white' : 'text-zinc-600'}`}><span>Reportes</span> {activeTab === 'submissions' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('planificacion'); setShowPdfPreview(false); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'planificacion' ? 'text-white' : 'text-zinc-600'}`}><span>Planificación</span> {activeTab === 'planificacion' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => { setActiveTab('manage'); setShowPdfPreview(false); }} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'manage' ? 'text-white' : 'text-zinc-600'}`}><span>Configurar</span> {activeTab === 'manage' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                    </div>

                    {activeTab === 'overview' ? (
                        <div key="tab-overview" className="space-y-8 animate-in mt-4">
                            {/* KPI Metrics */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-amber-500/10 rounded-full blur-3xl group-hover:bg-amber-500/20 transition-all"></div>
                                    <div className="flex items-center justify-between mb-4 relative z-10">
                                        <div className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Checklists Hoy</div>
                                        <div className="w-8 h-8 rounded-full bg-zinc-950 flex items-center justify-center text-amber-500 border border-zinc-800"><Icon name="check-square" size={14} /></div>
                                    </div>
                                    <div className="text-5xl font-black text-white relative z-10">{totalSubmissionsToday}</div>
                                </div>

                                <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl group-hover:bg-emerald-500/20 transition-all"></div>
                                    <div className="flex items-center justify-between mb-4 relative z-10">
                                        <div className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Cumplimiento Global</div>
                                        <div className="w-8 h-8 rounded-full bg-zinc-950 flex items-center justify-center text-emerald-500 border border-zinc-800"><Icon name="activity" size={14} /></div>
                                    </div>
                                    <div className="text-5xl font-black relative z-10 text-emerald-400">{avgCompletion}%</div>
                                </div>

                                <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-red-500/10 rounded-full blur-3xl group-hover:bg-red-500/20 transition-all"></div>
                                    <div className="flex items-center justify-between mb-4 relative z-10">
                                        <div className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">Alertas de Merma</div>
                                        <div className="w-8 h-8 rounded-full bg-zinc-950 flex items-center justify-center text-red-500 border border-zinc-800"><Icon name="alert-triangle" size={14} /></div>
                                    </div>
                                    <div className="text-5xl font-black relative z-10 text-red-400">{totalShrinkageItems} <span className="text-sm text-red-500/50 uppercase tracking-widest">Items</span></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                {/* Activity Area Chart */}
                                <div className="bg-zinc-900/50 border border-zinc-800 p-6 rounded-3xl">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6 border-l-2 border-amber-500 pl-4 ml-1">Actividad por Área (Hoy)</h3>
                                    {Object.keys(areaCounts).length === 0 ? (
                                        <div className="text-zinc-600 text-[10px] uppercase font-bold tracking-widest text-center py-10">Sin actividad</div>
                                    ) : (
                                        <div className="space-y-4">
                                            {Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).map(([area, count]) => (
                                                <div key={area} className="flex items-center gap-4">
                                                    <div className="w-32 text-xs font-bold text-zinc-300 uppercase tracking-tight truncate">{area}</div>
                                                    <div className="flex-1 h-3 bg-zinc-950 rounded-full overflow-hidden border border-zinc-800">
                                                        <div className="h-full bg-amber-500 rounded-full" style={{ width: `${(count / maxActivityArea) * 100}%` }}></div>
                                                    </div>
                                                    <div className="w-8 text-right text-xs font-black text-amber-500">{count}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Recent Activity Feed */}
                                <div className="bg-zinc-900/50 border border-zinc-800 p-6 rounded-3xl">
                                    <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mb-6 border-l-2 border-amber-500 pl-4 ml-1">Últimos Movimientos</h3>
                                    <div className="space-y-4">
                                        {recentActivity.length === 0 ? (
                                            <div className="text-zinc-600 text-[10px] uppercase font-bold tracking-widest text-center py-10">Sin actividad reciente</div>
                                        ) : (
                                            recentActivity.map(sub => (
                                                <div key={sub.id} className="flex items-start gap-4 pb-4 border-b border-zinc-800/50 last:border-0 last:pb-0">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 border ${sub.checklistType === 'shrinkage' ? 'bg-red-500/10 text-red-500 border-red-500/20' : sub.checklistType === 'inventory' ? 'bg-indigo-500/10 text-indigo-500 border-indigo-500/20' : 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20'}`}>
                                                        <Icon name={sub.checklistType === 'shrinkage' ? 'trash-2' : sub.checklistType === 'inventory' ? 'clipboard-list' : 'check'} size={14} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-start">
                                                            <p className="text-white font-bold text-sm tracking-tight">{sub.checklistTitle}</p>
                                                            <span className="text-zinc-500 text-[9px] font-black uppercase">{new Date(sub.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                        </div>
                                                        <p className="text-zinc-500 text-[10px] uppercase font-bold mt-1 tracking-widest">{sub.bartender} • {sub.area || 'General'}</p>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : activeTab === 'submissions' ? (
                        <div key="tab-submissions" className="space-y-6">
                            <div className="flex justify-end mb-4 no-print">
                                {!showPdfPreview ? (
                                    <button onClick={() => setShowPdfPreview(true)} className="bg-amber-500 text-zinc-950 px-5 py-3 rounded-2xl flex items-center gap-2 font-black text-xs uppercase tracking-widest shadow-xl hover:bg-amber-400 transition-all">
                                        <Icon name="file-text" size={16} /> Ver Resumen Diario PDF
                                    </button>
                                ) : (
                                    <div className="flex gap-4">
                                        <button onClick={() => window.print()} className="bg-amber-500 text-zinc-950 px-5 py-3 rounded-2xl flex items-center gap-2 font-black text-xs uppercase tracking-widest shadow-xl hover:bg-amber-400 transition-all">
                                            <Icon name="printer" size={16} /> Imprimir PDF
                                        </button>
                                        <button onClick={() => setShowPdfPreview(false)} className="bg-zinc-800 text-zinc-300 px-5 py-3 rounded-2xl flex items-center gap-2 font-black text-xs uppercase tracking-widest hover:bg-zinc-700 transition-all">
                                            <Icon name="x" size={16} /> Cerrar
                                        </button>
                                    </div>
                                )}
                            </div>

                            {showPdfPreview ? (
                                <div className="bg-white text-black p-8 rounded-3xl min-h-screen">
                                    <div className="pdf-header text-center flex flex-col items-center">
                                        <span className="text-3xl font-black tracking-tighter mb-2">FENÓMENO Bar Ops</span>
                                        <span className="text-sm tracking-widest text-zinc-500">REPORTE DIARIO DE OPERACIONES</span>
                                        <span className="text-xs font-bold mt-2">{new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    </div>

                                    {Object.keys(groupedReport).length === 0 ? (
                                        <div className="text-center text-zinc-500 py-10 font-bold uppercase">No hay reportes registrados hoy.</div>
                                    ) : (
                                        Object.entries(groupedReport).map(([area, categories]) => (
                                            <div key={area} className="pdf-section mb-12">
                                                <h2 className="text-2xl font-black uppercase border-b-4 border-black pb-2 mb-6">{area}</h2>

                                                {/* Inject Pre-planned Lab Production ONLY in the Laboratorio area */}
                                                {area === 'Laboratorio' && dailyLabPlan.length > 0 && (
                                                    <div className="pdf-item bg-amber-50 border border-amber-200 !px-4 !py-3 mb-8">
                                                        <h4 className="font-black text-amber-800 uppercase tracking-widest text-[10px] mb-3">PLAN DE PRODUCCIÓN SUGERIDO (MANAGER)</h4>
                                                        <div className="flex flex-wrap gap-2">
                                                            {dailyLabPlan.map(item => (
                                                                <span key={item.name} className="bg-white border border-amber-300 text-black px-2 py-1 rounded-md text-[9px] font-bold uppercase">{item.name}{item.qty ? ` - ${item.qty}` : ''}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {Object.entries(categories).map(([category, subs]) => (
                                                    <div key={category} className="mb-8">
                                                        <h3 className="pdf-section-title text-lg">{category}</h3>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            {subs.map(sub => (
                                                                <div key={sub.id} className="pdf-item bg-zinc-50 p-4 border border-zinc-200 shadow-sm">
                                                                    <div className="flex justify-between items-start mb-3 border-b border-zinc-200 pb-2">
                                                                        <div>
                                                                            <h4 className="font-black text-sm uppercase">{sub.checklistTitle}</h4>
                                                                            <p className="text-xs text-zinc-500 font-bold mt-1">Por: {sub.bartender} a las {new Date(sub.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                                                        </div>
                                                                        {sub.checklistType !== 'inventory' && sub.checklistType !== 'shrinkage' && (
                                                                            <div className="font-black text-lg">{Math.round((sub.completedIndices.length / sub.tasks.length) * 100)}%</div>
                                                                        )}
                                                                    </div>

                                                                    {sub.observations && (
                                                                        <div className="mb-3 p-2 bg-amber-50 border border-amber-200 rounded text-xs italic">
                                                                            <span className="font-bold">Nota:</span> "{sub.observations}"
                                                                        </div>
                                                                    )}

                                                                    <div className="space-y-1">
                                                                        {sub.checklistType === 'inventory' ? (
                                                                            sub.tasks.map((t, i) => (
                                                                                <div key={i} className="pdf-task text-xs">
                                                                                    <span>{t}</span>
                                                                                    <span className="font-bold">{sub.inventoryValues?.[i] || 0}</span>
                                                                                </div>
                                                                            ))
                                                                        ) : sub.checklistType === 'shrinkage' ? (
                                                                            sub.shrinkageRecords?.map((rec, i) => (
                                                                                <div key={i} className="pdf-task flex-col items-start gap-1">
                                                                                    <div className="flex justify-between w-full">
                                                                                        <span className="font-bold">{rec.product}</span>
                                                                                        <span className="font-black text-red-600">{rec.qty} {rec.unit}</span>
                                                                                    </div>
                                                                                    <span className="text-[10px] text-zinc-500">{rec.reason} • {rec.disposal}</span>
                                                                                </div>
                                                                            ))
                                                                        ) : (
                                                                            sub.tasks.map((t, i) => (
                                                                                <div key={i} className="pdf-task text-xs">
                                                                                    <span className={sub.completedIndices.includes(i) ? '' : 'line-through text-zinc-400'}>{t}</span>
                                                                                    <span className="font-black">{sub.completedIndices.includes(i) ? '✓' : '—'}</span>
                                                                                </div>
                                                                            ))
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))
                                    )}
                                </div>
                            ) : (
                                <>
                                    {submissions.map(sub => (
                                        <div key={sub.id} className="bg-zinc-900 border border-zinc-800 rounded-[2.5rem] p-8 shadow-xl animate-in">
                                            <div className="flex justify-between items-start mb-6">
                                                <div className="text-left">
                                                    <span className={`text-[10px] font-black px-3 py-1.5 rounded-md uppercase tracking-widest border ${sub.checklistType === 'inventory' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-amber-500/10 text-amber-500 border-amber-500/20'}`}>{sub.checklistTitle}</span>
                                                    <h4 className="text-3xl font-black uppercase text-white tracking-tight mt-3 italic leading-tight">{sub.bartender}</h4>
                                                    <p className="text-zinc-600 text-[10px] font-bold uppercase mt-1 tracking-tighter">{new Date(sub.timestamp).toLocaleString()}</p>
                                                </div>
                                                {sub.checklistType !== 'inventory' && sub.checklistType !== 'shrinkage' && (
                                                    <div className="text-4xl font-black text-amber-500 leading-none">{Math.round((sub.completedIndices.length / sub.tasks.length) * 100)}%</div>
                                                )}
                                            </div>
                                            {sub.observations && <div className="p-5 bg-zinc-950 rounded-2xl border border-zinc-800 mb-6 text-sm text-zinc-300 italic flex gap-4"><Icon name="alert-circle" size={20} className="text-amber-500 flex-shrink-0" /><span>"{sub.observations}"</span></div>}
                                            <div className={`grid ${sub.checklistType === 'inventory' ? 'grid-cols-1 gap-2' : 'grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-10'} text-[10px] font-black uppercase tracking-widest`}>
                                                {sub.tasks.map((t, i) => (
                                                    sub.checklistType === 'inventory' ? (
                                                        <div key={i} className="flex justify-between items-center py-3 border-b border-zinc-800/50">
                                                            <span className="text-zinc-400">{t}</span>
                                                            <span className="text-white text-sm font-black bg-zinc-950 px-3 py-1 rounded-lg border border-zinc-800 flex items-center gap-1">{sub.inventoryValues?.[i] || 0}</span>
                                                        </div>
                                                    ) : (
                                                        <div key={i} className="flex gap-3 items-center py-2 border-b border-zinc-800/30">
                                                            <div className={`w-2.5 h-2.5 rounded-full ${sub.completedIndices.includes(i) ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.4)]'}`}></div>
                                                            <span className={sub.completedIndices.includes(i) ? 'text-zinc-300' : 'text-zinc-700 line-through decoration-zinc-800'}>{t}</span>
                                                        </div>
                                                    )
                                                ))}
                                            </div>
                                            {sub.checklistType === 'shrinkage' && sub.shrinkageRecords && sub.shrinkageRecords.length > 0 && (
                                                <div className="space-y-2 mt-4">
                                                    {sub.shrinkageRecords.map((rec, idx) => (
                                                        <div key={idx} className={`p-4 rounded-xl border flex flex-col sm:flex-row sm:items-center justify-between gap-2 ${rec.reason === 'Rotura' || rec.reason === 'Error de preparación' ? 'bg-red-500/10 border-red-500/30' : 'bg-zinc-950 border-zinc-800'}`}>
                                                            <div>
                                                                <p className={`font-bold text-sm tracking-tight uppercase ${rec.reason === 'Rotura' || rec.reason === 'Error de preparación' ? 'text-red-400' : 'text-white'}`}>{rec.product}</p>
                                                                <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest">{rec.reason} • {rec.disposal}</p>
                                                            </div>
                                                            <span className={`text-sm font-black px-3 py-1 rounded-lg border ${rec.reason === 'Rotura' || rec.reason === 'Error de preparación' ? 'border-red-500/50 bg-red-500/20 text-red-500' : 'border-zinc-700 bg-zinc-900 text-amber-500'}`}>{rec.qty} {rec.unit}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </>
                            )}
                        </div>
                    ) : activeTab === 'planificacion' ? (
                        <div key="tab-planificacion" className="space-y-8 animate-in mt-4">
                            <div className="bg-zinc-900 border border-zinc-800 rounded-[2.5rem] p-8 space-y-6">
                                <div>
                                    <h4 className="text-xl font-black text-white uppercase tracking-tight mb-2 flex items-center gap-2"><Icon name="calendar-days" className="text-amber-500" size={20} /> Distribución Semanal de Tareas</h4>
                                    <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest mb-4">Escribe los horarios y zonas de trabajo semanales del staff</p>
                                    <textarea
                                        value={weeklySchedule}
                                        onChange={(e) => setWeeklySchedule(e.target.value)}
                                        className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white focus:ring-2 focus:ring-amber-500 outline-none resize-none min-h-[150px] font-mono text-sm leading-relaxed"
                                        placeholder="Lunes:
- Juan: Barra Principal (Apertura)
- María: Lab (Producción)..."
                                    ></textarea>
                                </div>
                                <div className="pt-6 border-t border-zinc-800/50">
                                    <div className="flex justify-between items-end mb-4">
                                        <div>
                                            <h4 className="text-xl font-black text-white uppercase tracking-tight mb-2 flex items-center gap-2"><Icon name="test-tubes" className="text-amber-500" size={20} /> Plan de Producción Lab</h4>
                                            <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest">Selecciona los lotes o preparaciones críticas para hoy</p>
                                        </div>
                                        <button onClick={() => setDailyLabPlan([])} className="text-xs font-black uppercase tracking-widest text-zinc-400 hover:text-amber-500 transition-colors bg-zinc-950 px-4 py-2 rounded-xl border border-zinc-800 hover:border-amber-500/50">Limpiar Todo</button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-zinc-950/50 border border-zinc-800/50 rounded-2xl p-4">
                                            <h5 className="text-white text-xs font-black uppercase mb-3 flex items-center gap-2"><Icon name="flask-conical" size={14} className="text-amber-500" /> Premixes</h5>
                                            <div className="flex flex-col gap-2">
                                                {LAB_PREMIXES.map(item => {
                                                    const isSelected = dailyLabPlan.some(i => i.name === item);
                                                    const currentQty = isSelected ? dailyLabPlan.find(i => i.name === item).qty : '';
                                                    return (
                                                        <div key={`admin-premix-${item}`} className={`flex flex-col p-3 rounded-xl transition-all ${isSelected ? 'bg-amber-500/10 border border-amber-500/30 shadow-sm' : 'bg-zinc-900 border border-zinc-800 hover:bg-zinc-800'}`}>
                                                            <label className="flex items-center gap-3 cursor-pointer">
                                                                <input type="checkbox" className="hidden" checked={isSelected} onChange={(e) => {
                                                                    if (e.target.checked) setDailyLabPlan([...dailyLabPlan, { name: item, qty: '5 Bolsas 700ml' }]);
                                                                    else setDailyLabPlan(dailyLabPlan.filter(i => i.name !== item));
                                                                }} />
                                                                <Icon name={isSelected ? "check-square" : "square"} size={16} className={isSelected ? "text-amber-500" : "text-zinc-600"} />
                                                                <span className={`text-[10px] font-bold uppercase tracking-widest leading-tight ${isSelected ? 'text-amber-500' : 'text-zinc-400'}`}>{item}</span>
                                                            </label>
                                                            {isSelected && (
                                                                <input
                                                                    type="text"
                                                                    placeholder="Ej: 2 bolsas 700ml"
                                                                    value={currentQty}
                                                                    onChange={(e) => setDailyLabPlan(dailyLabPlan.map(i => i.name === item ? { ...i, qty: e.target.value } : i))}
                                                                    className="mt-3 bg-zinc-950/80 border border-amber-500/30 rounded-lg p-3 text-white font-bold text-xs outline-none focus:border-amber-500 w-full"
                                                                />
                                                            )}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                        <div className="bg-zinc-950/50 border border-zinc-800/50 rounded-2xl p-4">
                                            <h5 className="text-white text-xs font-black uppercase mb-3 flex items-center gap-2"><Icon name="test-tube-2" size={14} className="text-amber-500" /> Preparaciones (Preps)</h5>
                                            <div className="flex flex-col gap-2">
                                                {LAB_PREPS.map(item => {
                                                    const isSelected = dailyLabPlan.some(i => i.name === item);
                                                    const currentQty = isSelected ? dailyLabPlan.find(i => i.name === item).qty : '';
                                                    return (
                                                        <div key={`admin-prep-${item}`} className={`flex flex-col p-3 rounded-xl transition-all ${isSelected ? 'bg-amber-500/10 border border-amber-500/30 shadow-sm' : 'bg-zinc-900 border border-zinc-800 hover:bg-zinc-800'}`}>
                                                            <label className="flex items-center gap-3 cursor-pointer">
                                                                <input type="checkbox" className="hidden" checked={isSelected} onChange={(e) => {
                                                                    if (e.target.checked) setDailyLabPlan([...dailyLabPlan, { name: item, qty: '2 Litros' }]);
                                                                    else setDailyLabPlan(dailyLabPlan.filter(i => i.name !== item));
                                                                }} />
                                                                <Icon name={isSelected ? "check-square" : "square"} size={16} className={isSelected ? "text-amber-500" : "text-zinc-600"} />
                                                                <span className={`text-[10px] font-bold uppercase tracking-widest leading-tight ${isSelected ? 'text-amber-500' : 'text-zinc-400'}`}>{item}</span>
                                                            </label>
                                                            {isSelected && (
                                                                <input
                                                                    type="text"
                                                                    placeholder="Ej: 2 Litros"
                                                                    value={currentQty}
                                                                    onChange={(e) => setDailyLabPlan(dailyLabPlan.map(i => i.name === item ? { ...i, qty: e.target.value } : i))}
                                                                    className="mt-3 bg-zinc-950/80 border border-amber-500/30 rounded-lg p-3 text-white font-bold text-xs outline-none focus:border-amber-500 w-full"
                                                                />
                                                            )}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button
                                    onClick={savePlanning}
                                    disabled={isSavingPlanning}
                                    className="w-full bg-amber-500 text-zinc-950 font-black tracking-widest uppercase py-4 rounded-xl shadow-xl hover:bg-amber-400 disabled:opacity-50 transition-all">
                                    {isSavingPlanning ? 'Guardando...' : 'Guardar Planificación'}
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div key="tab-manage" className="grid gap-8 mt-4">
                            {editingList ? (
                                <ChecklistEditor initialData={editingList} onSave={() => setEditingList(null)} onCancel={() => setEditingList(null)} />
                            ) : (
                                ['Barra Principal', 'Barra Secundaria', 'Laboratorio', 'General'].map(areaOption => {
                                    const areaLists = checklists.filter(c => (c.area || 'General') === areaOption);
                                    if (areaLists.length === 0) return null;
                                    return (
                                        <div key={areaOption} className="space-y-4">
                                            <h3 className="text-xl font-black text-amber-500 uppercase tracking-widest flex items-center gap-2 border-b-2 border-zinc-800 pb-2">
                                                <Icon name={areaOption === 'Barra Principal' ? 'sun' : areaOption === 'Barra Secundaria' ? 'moon' : areaOption === 'Laboratorio' ? 'flask-conical' : 'folder'} size={20} />
                                                {areaOption}
                                            </h3>
                                            <div className="grid gap-4">
                                                {areaLists.map(list => (
                                                    <div key={list.id} className="bg-zinc-900 border border-zinc-800 p-7 rounded-[2.5rem] flex items-center justify-between group hover:border-amber-500/20 transition-all">
                                                        <div className="flex items-center gap-5 text-left">
                                                            <div className="w-12 h-12 rounded-2xl bg-zinc-800 flex items-center justify-center text-zinc-500 group-hover:text-amber-500 transition-colors"><Icon name="settings" size={22} /></div>
                                                            <div>
                                                                <h4 className="font-black text-lg leading-tight uppercase tracking-tighter text-white tracking-widest">{list.title}</h4>
                                                                <p className="text-zinc-600 text-[10px] font-black uppercase tracking-widest mt-1 italic">{list.category} {list.type === 'inventory' ? '• Inventario' : ''} • {list.tasks?.length} Ítems</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-3">
                                                            <button onClick={() => setEditingList(list)} className="p-3 bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded-xl transition-all shadow-lg"><Icon name="edit-3" size={18} /></button>
                                                            <button onClick={() => setChecklistToDelete(list.id)} className="p-3 bg-zinc-800 text-zinc-400 hover:text-red-500 hover:bg-red-500/10 rounded-xl transition-all shadow-lg"><Icon name="trash-2" size={18} /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    )}

                    {checklistToDelete && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
                            <div className="bg-zinc-900 border border-zinc-800 rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl animate-in zoom-in-95 duration-200">
                                <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/30">
                                    <Icon name="alert-triangle" size={32} className="text-red-500" />
                                </div>
                                <h3 className="text-2xl font-black text-white uppercase tracking-tight mb-2">¿Eliminar Protocolo?</h3>
                                <p className="text-zinc-500 text-sm font-bold uppercase tracking-widest mb-8">Esta acción no se puede deshacer.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setChecklistToDelete(null)} className="flex-1 py-4 bg-zinc-800 text-white font-black uppercase tracking-widest rounded-xl hover:bg-zinc-700 transition-colors">Cancelar</button>
                                    <button onClick={confirmDeletion} className="flex-1 py-4 bg-red-500 text-white font-black uppercase tracking-widest rounded-xl hover:bg-red-600 shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {toastMessage && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 animate-in slide-in-from-bottom-5 fade-in duration-300">
                            <div className={`flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl font-black uppercase tracking-widest text-xs border ${toastMessage.type === 'success' ? 'bg-amber-500 text-zinc-950 border-amber-400' : 'bg-red-500 text-white border-red-400'}`}>
                                <Icon name={toastMessage.type === 'success' ? 'check-circle' : 'alert-circle'} size={18} />
                                {toastMessage.text}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ChecklistEditor({ initialData, onSave, onCancel }) {
            const [formData, setFormData] = useState(initialData);
            const [draggedIndex, setDraggedIndex] = useState(null);

            const updateTask = (val, idx) => {
                const newTasks = [...formData.tasks];
                newTasks[idx] = val;
                setFormData({ ...formData, tasks: newTasks });
            };

            const addTask = () => {
                setFormData(prev => ({ ...prev, tasks: [...prev.tasks, ""] }));
            };

            const removeTask = (idx) => {
                setFormData(prev => ({ ...prev, tasks: prev.tasks.filter((_, i) => i !== idx) }));
            };

            const onDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;
                const newTasks = [...formData.tasks];
                const item = newTasks[draggedIndex];
                newTasks.splice(draggedIndex, 1);
                newTasks.splice(index, 0, item);
                setDraggedIndex(index);
                setFormData({ ...formData, tasks: newTasks });
            };

            const save = async () => {
                if (!formData.title) { alert("Escribe un título"); return; }
                const finalTasks = formData.tasks.filter(t => t.trim() !== "");
                if (finalTasks.length === 0) { alert("Añade al menos un paso"); return; }

                const { db, collection, doc, addDoc, updateDoc, appId } = window.FB;
                try {
                    const data = { ...formData, tasks: finalTasks };
                    if (formData.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklists', formData.id), data);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklists'), data);
                    }
                    onSave();
                } catch (err) { console.error(err); alert("Error de conexión"); }
            };

            return (
                <div className="bg-zinc-900 p-10 rounded-[3rem] border border-zinc-800 space-y-8 animate-in shadow-2xl">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                        <div className="space-y-2">
                            <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Nombre</label>
                            <input className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.title} onChange={e => setFormData({ ...formData, title: e.target.value })} placeholder="Ej: CIERRE BARRA PRINCIPAL" />
                        </div>
                        <div className="space-y-2">
                            <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Categoría / Tipo</label>
                            <select className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.category} onChange={e => setFormData({ ...formData, category: e.target.value })}>
                                <option>Apertura</option><option>Producción</option><option>Inventario</option><option>Cierre</option>
                            </select>
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Área Asignada</label>
                        <select className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.area || 'Barra Principal'} onChange={e => setFormData({ ...formData, area: e.target.value })}>
                            <option>Barra Principal</option><option>Barra Secundaria</option><option>Laboratorio</option>
                        </select>
                    </div>
                    <div className="space-y-4">
                        <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic text-amber-500">Pasos (Arrastra para reordenar)</label>
                        <div className="space-y-3 max-h-[45vh] overflow-y-auto pr-2 scrollbar-hide">
                            {formData.tasks.map((t, i) => (
                                <div
                                    key={i}
                                    draggable="true"
                                    onDragStart={(e) => onDragStart(e, i)}
                                    onDragOver={(e) => onDragOver(e, i)}
                                    onDragEnd={() => setDraggedIndex(null)}
                                    className={`flex gap-4 items-center task-row transition-opacity ${draggedIndex === i ? 'opacity-40' : 'opacity-100'}`}
                                >
                                    <div className="drag-handle p-2 text-zinc-700 hover:text-zinc-400 drag-icon transition-colors">
                                        <Icon name="grip-vertical" size={20} />
                                    </div>
                                    <input className="flex-1 bg-zinc-950 border border-zinc-800 rounded-2xl p-4 text-sm text-white focus:border-amber-500/50 outline-none uppercase font-bold" value={t} onChange={e => updateTask(e.target.value, i)} placeholder={`Punto operativo ${i + 1}`} />
                                    <button onClick={() => removeTask(i)} className="p-4 bg-zinc-800 text-zinc-600 hover:text-red-500 rounded-2xl transition-all shadow-lg"><Icon name="trash-2" size={18} /></button>
                                </div>
                            ))}
                        </div>
                        <button onClick={addTask} className="w-full py-5 border border-dashed border-zinc-800 rounded-3xl text-zinc-600 font-black uppercase text-[10px] hover:border-amber-500 hover:text-amber-500 transition-all tracking-[0.25em] shadow-inner">+ Añadir Nuevo Paso</button>
                    </div>
                    <div className="flex gap-5 pt-8 border-t border-zinc-800">
                        <button onClick={save} className="flex-1 bg-amber-500 text-zinc-950 py-5 rounded-[2.5rem] font-black uppercase tracking-[0.25em] shadow-xl active:scale-95 transition-all text-[10px]">Guardar Cambios</button>
                        <button onClick={onCancel} className="px-10 py-5 bg-zinc-800 text-white rounded-[2.5rem] font-black uppercase active:scale-95 transition-all text-[10px] tracking-widest tracking-[0.25em]">Cancelar</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>