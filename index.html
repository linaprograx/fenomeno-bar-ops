<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FENÓMENO Bar Ops</title>
    <!-- Bibliotecas vía CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.330.0"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #f4f4f5;
        }

        .animate-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .task-row:hover .drag-icon {
            opacity: 1;
        }

        .drag-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <!-- Carga de Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWO05LJao0ZWIH65hIBaGSrREXWKASFMU",
            authDomain: "fenomeno---bar-ops.firebaseapp.com",
            projectId: "fenomeno---bar-ops",
            storageBucket: "fenomeno---bar-ops.firebasestorage.app",
            messagingSenderId: "166164759157",
            appId: "1:166164759157:web:60366f50df3ee0d574ee3c",
            measurementId: "G-FGMDNW8WHY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "fenomeno-ops-v6"; // Nueva versión para las áreas de barra e inventarios reales

        window.FB = {
            db, auth, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query,
            signInAnonymously, onAuthStateChanged, appId
        };
    </script>

    <!-- Código de la Aplicación -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('user');
            const [activeChecklist, setActiveChecklist] = useState(null);
            const [checklists, setChecklists] = useState([]);
            const [submissions, setSubmissions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB) {
                        clearInterval(checkFB);
                        initApp();
                    }
                }, 100);

                const initApp = async () => {
                    const { auth, db, appId, collection, onSnapshot, signInAnonymously, onAuthStateChanged } = window.FB;

                    onAuthStateChanged(auth, (u) => {
                        if (!u) { signInAnonymously(auth).catch(console.error); }
                        setUser(u);
                        setLoading(false);
                    });

                    const qChecklists = collection(db, 'artifacts', appId, 'public', 'data', 'checklists');
                    onSnapshot(qChecklists, (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (list.length === 0) seedFenomenoData();
                        setChecklists(list);
                    });

                    const qSubmissions = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
                    onSnapshot(qSubmissions, (snapshot) => {
                        const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSubmissions(list.sort((a, b) => b.timestamp - a.timestamp));
                    });
                };
                return () => clearInterval(checkFB);
            }, []);

            const seedFenomenoData = async () => {
                const { db, collection, addDoc, appId } = window.FB;
                const defaultLists = [
                    {
                        title: "Apertura Barra Principal", category: "Apertura", area: "Barra Principal", type: "standard",
                        tasks: [
                            "Colocar cristalería en hielo (Estación 1 y 2)",
                            "Montar estaciones completamente (Mise en place)",
                            "Rellenar batches y premix según rotación",
                            "Comprobar stock de premix, frutas y garnish",
                            "Rellenar stock de hielos (Estaciones y reserva)",
                            "Vaciar basuras antes del inicio del servicio",
                            "Rellenar aperitivos y snacks",
                            "Comprobar faltantes de destilados en barra",
                            "Revisar carga de neveras a tope",
                            "Revisar cambio en caja de cobro"
                        ]
                    },
                    {
                        title: "Cierre Barra Principal", category: "Cierre", area: "Barra Principal", type: "standard",
                        tasks: [
                            "Neveras cargadas A TOPE (Sin excepciones)",
                            "Limpieza absoluta de todas las superficies y raíles",
                            "Vaciar TODAS las basuras y lavar cubos",
                            "Limpieza profunda de hieleras y drenajes",
                            "Suelo barrido y fregado con desengrasante",
                            "Organizar botellería por familias",
                            "Máquinas (Café/Hielo) limpias y drenadas",
                            "Dejar todo absolutamente limpio",
                            "Reporte de incidencias y mermas enviado",
                            "Equipos no críticos en OFF"
                        ]
                    },
                    {
                        title: "Apertura Barra Secundaria", category: "Apertura", area: "Barra Secundaria", type: "standard",
                        tasks: [
                            "Colocar cristalería en hielo",
                            "Montar estación de servicio completa",
                            "Comprobar stock de premix y decoración",
                            "Rellenar stock de hielos",
                            "Vaciar basuras antes del servicio",
                            "Verificar que neveras estén a tope"
                        ]
                    },
                    {
                        title: "Cierre Barra Secundaria", category: "Cierre", area: "Barra Secundaria", type: "standard",
                        tasks: [
                            "Neveras cargadas A TOPE",
                            "Limpieza absoluta de superficies",
                            "Vaciar basuras y lavar cubos",
                            "Limpieza de drenajes y hieleras",
                            "Suelo fregado y todo absolutamente limpio",
                            "Organizar botellas y stock"
                        ]
                    },
                    {
                        title: "Apertura Lab Fenómeno", category: "Apertura", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Revisar inventario de preps al comenzar turno",
                            "Identificar preparaciones críticas según falta",
                            "Verificar maquinaria (Sous-vide, vacío, etc)",
                            "Sanitización total de zona de trabajo"
                        ]
                    },
                    {
                        title: "Producción Lab (3L - 5L)", category: "Producción", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Producción de lotes grandes (3L a 5L por cóctel)",
                            "Seguir recetas al pie de la letra (Extremo Cuidado)",
                            "Trabajar con extremo cuidado y rigor",
                            "Mantener limpieza profunda constante en producción",
                            "Etiquetado completo (Fecha y caducidad)",
                            "Control de calidad sensorial de cada lote"
                        ]
                    },
                    {
                        title: "Soporte Lab (Noche)", category: "Producción", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Surtir a las dos barras al instante si algo acaba",
                            "Reaccionar al instante ante roturas de stock en barra",
                            "Mantenimiento de limpieza en zona de preps",
                            "Basura botada y Lab impecable al cierre",
                            "Revisión de stock para turno de mañana"
                        ]
                    },
                    {
                        title: "Inventario de Producción (Preps)", category: "Inventario", area: "Laboratorio", type: "inventory", unit: "L/Ud",
                        tasks: [
                            "limon clarificado",
                            "litchy clarificado",
                            "sirope de maiz tostado",
                            "sal de huitlacoche",
                            "cortar hojas de maiz seco",
                            "agua de sandia",
                            "cortar sandias para garnish",
                            "agua enzimatica de pepino",
                            "zumo de manzana fortificado",
                            "brochetas de garnish",
                            "agua de tamarindo clarificado",
                            "velos de magi (gluten)",
                            "tintura de moras (glucosa)",
                            "mix de heirbas y orgeat",
                            "chip de hierbas",
                            "miel de ajo",
                            "vodka de trufa",
                            "tejas de merengue",
                            "mix de maracuya y rass el hanout",
                            "lamina de chocolate",
                            "milkpunch orbita",
                            "coco rayado",
                            "agua de tomate",
                            "carbonatados en sifon",
                            "espuma de queso",
                            "guayaba clarificada"
                        ]
                    },
                    {
                        title: "Inventario de Premixes", category: "Inventario", area: "Laboratorio", type: "inventory", unit: "Bolsa 700ml",
                        tasks: [
                            "origen",
                            "ruptura",
                            "antes de todo",
                            "destello",
                            "clorofila",
                            "nucleo",
                            "pulso",
                            "calma",
                            "singularidad",
                            "gravedad",
                            "orbita",
                            "eter",
                            "alma",
                            "aura",
                            "negroni",
                            "naked and famous",
                            "mai tai",
                            "dry martini",
                            "long island ice tea",
                            "Margarita clasica",
                            "Margarita spicy"
                        ]
                    },
                    {
                        title: "Cierre Lab Fenómeno", category: "Cierre", area: "Laboratorio", type: "standard",
                        tasks: [
                            "Vaciar basuras y dejar todo absolutamente limpio",
                            "Lavar cubos de basura del laboratorio",
                            "Neveras del Lab cargadas A TOPE para mañana",
                            "Apagado de maquinaria de producción",
                            "Laboratorio sanitizado para el siguiente turno"
                        ]
                    }
                ];
                for (const list of defaultLists) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklists'), {
                        ...list,
                        type: list.type || 'standard'
                    });
                }
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-zinc-950">
                    <div className="flex flex-col items-center gap-6">
                        <div className="w-16 h-16 border-4 border-amber-500/20 border-t-amber-500 rounded-full animate-spin"></div>
                        <p className="text-zinc-500 text-xs font-black tracking-[0.3em] uppercase">Fenómeno Bar Ops...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-zinc-950">
                    <nav className="sticky top-0 z-50 border-b border-zinc-800 bg-zinc-950/80 backdrop-blur-xl px-4 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-amber-500 p-1.5 rounded-lg shadow-lg">
                                <Icon name="flask-conical" size={18} className="text-zinc-950" />
                            </div>
                            <h1 className="font-black text-xl tracking-tighter uppercase italic text-white leading-none tracking-widest">FENÓMENO</h1>
                        </div>
                        <div className="flex gap-1.5 bg-zinc-900 p-1 rounded-full border border-zinc-800">
                            <button onClick={() => setView('user')} className={`px-4 py-2 rounded-full text-[9px] font-black tracking-widest transition-all ${view === 'user' ? 'bg-zinc-700 text-white shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}>BARTENDERS</button>
                            <button onClick={() => {
                                if (isAdminAuthenticated) setView('admin');
                                else setView('pin');
                            }} className={`px-4 py-2 rounded-full text-[9px] font-black tracking-widest transition-all ${view === 'admin' || view === 'pin' ? 'bg-amber-500 text-zinc-950' : 'text-zinc-500 hover:text-zinc-300'}`}>MANAGER</button>
                        </div>
                    </nav>

                    <main className="max-w-2xl mx-auto p-4 pb-24 animate-in">
                        {view === 'user' ? (
                            activeChecklist ? (
                                <ChecklistForm checklist={activeChecklist} onCancel={() => setActiveChecklist(null)} />
                            ) : (
                                <UserDashboard checklists={checklists} onSelect={setActiveChecklist} />
                            )
                        ) : view === 'pin' ? (
                            <PinEntry onSuccess={() => { setIsAdminAuthenticated(true); setView('admin'); }} onCancel={() => setView('user')} />
                        ) : (
                            <AdminPanel checklists={checklists} submissions={submissions} />
                        )}
                    </main>
                </div>
            );
        }

        // --- COMPONENTES DE USUARIO ---

        function UserDashboard({ checklists, onSelect }) {
            const [activeArea, setActiveArea] = useState('Barra Principal');

            const areaChecklists = checklists
                .filter(c => (c.area || 'Barra Principal') === activeArea)
                .sort((a, b) => {
                    const order = { 'Apertura': 1, 'Producción': 2, 'Inventario': 3, 'Cierre': 4 };
                    return (order[a.category] || 9) - (order[b.category] || 9);
                });

            return (
                <div className="space-y-8 mt-4 animate-in">
                    <header>
                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none text-white tracking-widest animate-in">Operativa<br /><span className="text-amber-500 italic">FENÓMENO</span></h2>
                    </header>

                    <div className="flex gap-2 p-1 bg-zinc-900 border border-zinc-800 rounded-2xl overflow-x-auto scrollbar-hide">
                        {['Barra Principal', 'Barra Secundaria', 'Laboratorio'].map(area => (
                            <button
                                key={area}
                                onClick={() => setActiveArea(area)}
                                className={`flex-shrink-0 px-4 py-3 rounded-xl text-[10px] font-black tracking-widest transition-all ${activeArea === area ? 'bg-amber-500 text-zinc-950 shadow-lg' : 'text-zinc-500 hover:text-zinc-300'}`}
                            >
                                {area.toUpperCase()}
                            </button>
                        ))}
                    </div>

                    <div className="grid gap-3">
                        {areaChecklists.length === 0 ? (
                            <div className="p-8 text-center border-2 border-dashed border-zinc-800 rounded-3xl text-zinc-600 font-bold uppercase tracking-widest text-xs">Aún no hay listas en esta área</div>
                        ) : (
                            areaChecklists.map(item => (
                                <button key={item.id} onClick={() => onSelect(item)} className="w-full flex items-center justify-between p-6 bg-zinc-900/40 border border-zinc-800 rounded-[2.5rem] active:scale-95 transition-all group hover:border-amber-500/30">
                                    <div className="flex items-center gap-5 text-left">
                                        <div className="w-12 h-12 rounded-2xl bg-zinc-800 flex items-center justify-center text-zinc-400 group-hover:bg-amber-500 group-hover:text-zinc-950 transition-all duration-300">
                                            <Icon name={item.category === 'Apertura' ? 'sun' : item.category === 'Cierre' ? 'moon' : item.type === 'inventory' ? 'clipboard-list' : 'beaker'} size={24} />
                                        </div>
                                        <div>
                                            <p className="font-black text-lg uppercase tracking-tight leading-tight text-white">{item.title}</p>
                                            <p className="text-zinc-600 text-[10px] font-black uppercase tracking-widest mt-1 italic">{item.type === 'inventory' ? 'Inventario' : 'Checklist'} ({item.category}) • {item.tasks.length} {item.type === 'inventory' ? 'Ítems' : 'Tareas'}</p>
                                        </div>
                                    </div>
                                    <Icon name="chevron-right" className="text-zinc-700" />
                                </button>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        function ChecklistForm({ checklist, onCancel }) {
            const [completed, setCompleted] = useState([]);
            const [inventoryValues, setInventoryValues] = useState({});
            const [name, setName] = useState("");
            const [obs, setObs] = useState("");
            const [sending, setSending] = useState(false);
            const [sent, setSent] = useState(false);

            const isInventory = checklist.type === 'inventory';

            const toggle = (idx) => setCompleted(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);

            const updateInventory = (idx, val) => {
                setInventoryValues(prev => ({ ...prev, [idx]: val }));
            };

            const isValid = isInventory ?
                Object.keys(inventoryValues).length > 0 && Object.values(inventoryValues).some(v => v !== "") :
                completed.length > 0;

            const submit = async () => {
                if (!name || !isValid || sending) return;
                setSending(true);
                try {
                    const { db, collection, addDoc, appId } = window.FB;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), {
                        checklistTitle: checklist.title,
                        checklistType: checklist.type || 'standard',
                        bartender: name,
                        tasks: checklist.tasks,
                        completedIndices: completed,
                        inventoryValues: inventoryValues,
                        observations: obs,
                        timestamp: Date.now()
                    });
                    setSent(true);
                    setTimeout(onCancel, 1800);
                } catch (e) { console.error(e); setSending(false); }
            };

            if (sent) return (
                <div className="py-32 text-center animate-in">
                    <div className="w-24 h-24 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-8 shadow-2xl"><Icon name="check" size={48} className="text-zinc-950 font-black" /></div>
                    <h2 className="text-4xl font-black uppercase tracking-tighter text-white tracking-widest italic leading-none">Reporte OK</h2>
                    <p className="text-zinc-500 font-bold uppercase text-[10px] mt-4 tracking-[0.3em]">{name}</p>
                </div>
            );

            const progress = isInventory ?
                (Object.keys(inventoryValues).filter(k => inventoryValues[k]).length / checklist.tasks.length) * 100 :
                (completed.length / checklist.tasks.length) * 100;

            return (
                <div className="space-y-6 animate-in pb-10">
                    <button onClick={onCancel} className="text-zinc-600 text-[10px] font-black uppercase tracking-[0.2em] flex items-center gap-2 hover:text-white"><Icon name="arrow-left" size={14} /> Volver</button>
                    <div className="bg-zinc-900 border border-zinc-800 p-8 rounded-[2.5rem] shadow-2xl">
                        <span className="text-[10px] font-black text-amber-500 uppercase tracking-[0.2em]">{checklist.category} {isInventory && '• INVENTARIO'}</span>
                        <h2 className="text-3xl font-black uppercase tracking-tighter mt-1 text-white">{checklist.title}</h2>
                        <div className="mt-8 flex items-center justify-between">
                            <span className="text-3xl font-black text-amber-500 leading-none">{Math.round(progress)}%</span>
                        </div>
                        <div className="w-full h-3.5 bg-zinc-800 rounded-full mt-2 overflow-hidden border-2 border-zinc-800 shadow-inner">
                            <div className="h-full bg-amber-500 transition-all duration-700 shadow-[0_0_20px_rgba(245,158,11,0.4)]" style={{ width: `${progress}%` }}></div>
                        </div>
                    </div>
                    <div className="space-y-3">
                        {checklist.tasks.map((task, idx) => (
                            isInventory ? (
                                <div key={idx} className={`p-5 rounded-[1.5rem] border-2 transition-all flex items-center gap-5 ${inventoryValues[idx] ? 'bg-amber-500/5 border-amber-500/30' : 'bg-zinc-900/50 border-zinc-800'}`}>
                                    <div className="flex-1 font-bold text-sm tracking-tight leading-tight uppercase text-white">{task} <span className="text-zinc-500 text-[10px] tracking-widest block mt-1">{checklist.unit || "UDS"}</span></div>
                                    <input
                                        type="number"
                                        step="0.1"
                                        min="0"
                                        placeholder="0"
                                        value={inventoryValues[idx] || ""}
                                        onChange={e => updateInventory(idx, e.target.value)}
                                        className="w-20 bg-zinc-950 border border-zinc-800 rounded-xl p-3 text-center text-white font-black uppercase focus:border-amber-500 outline-none shadow-inner"
                                    />
                                </div>
                            ) : (
                                <div key={idx} onClick={() => toggle(idx)} className={`p-6 rounded-[1.5rem] border-2 transition-all flex items-start gap-5 cursor-pointer active:scale-[0.98] ${completed.includes(idx) ? 'bg-amber-500/5 border-amber-500/30 text-white shadow-lg' : 'bg-zinc-900/50 border-zinc-800 text-zinc-600 hover:border-zinc-700'}`}>
                                    <div className={`w-8 h-8 rounded-xl border-2 flex-shrink-0 flex items-center justify-center transition-all ${completed.includes(idx) ? 'bg-amber-500 border-amber-500 shadow-lg shadow-amber-500/20' : 'border-zinc-800 bg-zinc-950'}`}>
                                        {completed.includes(idx) && <Icon name="check" size={18} className="text-zinc-950 font-black" />}
                                    </div>
                                    <span className={`font-bold text-base tracking-tight leading-tight pt-1 uppercase ${completed.includes(idx) ? 'text-white' : 'text-zinc-500'}`}>{task}</span>
                                </div>
                            )
                        ))}
                    </div>
                    <div className="bg-zinc-900 p-8 rounded-[2.5rem] border border-zinc-800 space-y-6 shadow-xl">
                        <input type="text" placeholder="TU NOMBRE" className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={name} onChange={e => setName(e.target.value)} />
                        <textarea placeholder="INCIDENCIAS / MERMAS / STOCK..." className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white text-sm focus:ring-2 focus:ring-amber-500 outline-none" rows="3" value={obs} onChange={e => setObs(e.target.value)} />
                    </div>
                    <button disabled={!name || !isValid || sending} onClick={submit} className="w-full py-6 bg-amber-500 text-zinc-950 font-black rounded-[2.5rem] shadow-2xl active:scale-95 transition-all uppercase tracking-[0.25em] text-sm disabled:opacity-30">Enviar Reporte</button>
                </div>
            );
        }

        // --- PANEL DE ADMIN ---

        function PinEntry({ onSuccess, onCancel }) {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);
            const CORRECT_PIN = "2024";

            const handleSubmit = (e) => {
                e.preventDefault();
                if (pin === CORRECT_PIN) {
                    onSuccess();
                } else {
                    setError(true);
                    setPin("");
                }
            };

            return (
                <div className="flex flex-col items-center justify-center py-20 animate-in">
                    <div className="bg-zinc-900 border border-zinc-800 p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full text-center">
                        <div className="w-16 h-16 bg-zinc-800 rounded-2xl mx-auto flex items-center justify-center mb-6 text-amber-500">
                            <Icon name="lock" size={32} />
                        </div>
                        <h2 className="text-2xl font-black uppercase text-white tracking-widest mb-2">Acceso Manager</h2>
                        <p className="text-zinc-500 text-xs mb-8 uppercase tracking-widest">Introduce tu PIN</p>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="password"
                                maxLength={4}
                                value={pin}
                                onChange={(e) => { setPin(e.target.value); setError(false); }}
                                className={`w-full bg-zinc-950 border ${error ? 'border-red-500' : 'border-zinc-800'} rounded-2xl p-4 text-center text-4xl tracking-[1em] text-white focus:outline-none focus:border-amber-500 transition-colors mb-4`}
                                placeholder="••••"
                                autoFocus
                            />
                            {error && <p className="text-red-500 text-xs font-bold uppercase tracking-widest mb-4">PIN Incorrecto</p>}
                            <div className="flex gap-3 mt-4">
                                <button type="submit" className="flex-1 bg-amber-500 text-zinc-950 py-4 rounded-xl font-black uppercase tracking-widest text-xs">Entrar</button>
                                <button type="button" onClick={onCancel} className="flex-1 bg-zinc-800 text-white py-4 rounded-xl font-black uppercase tracking-widest text-xs">Atrás</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function AdminPanel({ checklists, submissions }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [editingList, setEditingList] = useState(null);

            // Dashboard Metrics
            const today = new Date().setHours(0, 0, 0, 0);
            const todaysSubmissions = submissions.filter(s => s.timestamp >= today);
            const totalSubmissionsToday = todaysSubmissions.length;

            let avgCompletion = 0;
            const standardSubmissions = todaysSubmissions.filter(s => s.checklistType !== 'inventory');
            if (standardSubmissions.length > 0) {
                const totalCompletion = standardSubmissions.reduce((acc, sub) => acc + (sub.completedIndices.length / sub.tasks.length), 0);
                avgCompletion = Math.round((totalCompletion / standardSubmissions.length) * 100);
            }

            const recentNotes = submissions.filter(s => s.observations && s.observations.trim() !== "").slice(0, 5);

            return (
                <div className="space-y-8 animate-in mt-4">
                    <header className="flex items-center justify-between">
                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none text-white tracking-widest italic">Manager<br /><span className="text-amber-500 not-italic">Dashboard</span></h2>
                        <button onClick={() => { setEditingList({ title: "", category: "Apertura", tasks: [""] }); setActiveTab('manage'); }} className="bg-amber-500 text-zinc-950 px-5 py-3 rounded-2xl flex items-center gap-2 font-black text-[10px] uppercase tracking-widest shadow-xl active:scale-95 transition-all">
                            <Icon name="plus" size={16} /> Crear
                        </button>
                    </header>

                    <div className="flex gap-10 border-b border-zinc-800 mb-8 overflow-x-auto scrollbar-hide">
                        <button onClick={() => setActiveTab('overview')} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'overview' ? 'text-white' : 'text-zinc-600'}`}>Resumen Diario {activeTab === 'overview' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => setActiveTab('submissions')} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'submissions' ? 'text-white' : 'text-zinc-600'}`}>Reportes {activeTab === 'submissions' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                        <button onClick={() => setActiveTab('manage')} className={`pb-4 px-1 text-xs font-black uppercase tracking-widest relative whitespace-nowrap transition-all ${activeTab === 'manage' ? 'text-white' : 'text-zinc-600'}`}>Configurar {activeTab === 'manage' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>}</button>
                    </div>

                    {activeTab === 'overview' ? (
                        <div className="space-y-6 animate-in">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl text-center">
                                    <div className="text-zinc-500 text-[10px] font-black uppercase tracking-widest mb-2 border-b border-zinc-800 pb-2">Checklists Hoy</div>
                                    <div className="text-5xl font-black text-white">{totalSubmissionsToday}</div>
                                </div>
                                <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl text-center">
                                    <div className="text-zinc-500 text-[10px] font-black uppercase tracking-widest mb-2 border-b border-zinc-800 pb-2">Cumplimiento</div>
                                    <div className={`text-5xl font-black ${avgCompletion === 100 ? 'text-green-500' : avgCompletion > 80 ? 'text-amber-500' : 'text-red-500'}`}>{avgCompletion}%</div>
                                </div>
                            </div>

                            <h3 className="text-[10px] font-black uppercase tracking-widest text-zinc-500 mt-8 mb-4 border-l-2 border-amber-500 pl-4 ml-1">Alertas y Notas Recientes</h3>
                            {recentNotes.length === 0 ? (
                                <div className="text-zinc-600 text-[10px] uppercase tracking-widest bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 text-center font-black">No hay alertas recientes</div>
                            ) : (
                                <div className="space-y-3">
                                    {recentNotes.map(sub => (
                                        <div key={sub.id} className="bg-zinc-900 border border-amber-500/30 p-5 rounded-3xl flex gap-4 items-start shadow-lg">
                                            <div className="text-amber-500 shrink-0 mt-1"><Icon name="message-square-warning" size={20} /></div>
                                            <div className="w-full">
                                                <div className="text-white text-sm font-bold italic">"{sub.observations}"</div>
                                                <div className="flex justify-between items-center mt-3 pt-3 border-t border-zinc-800/50">
                                                    <span className="text-zinc-500 text-[10px] font-black uppercase tracking-widest">{sub.bartender} • {sub.checklistTitle}</span>
                                                    <span className="text-zinc-600 text-[9px] font-bold uppercase">{new Date(sub.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ) : activeTab === 'submissions' ? (
                        <div className="space-y-6">
                            {submissions.map(sub => (
                                <div key={sub.id} className="bg-zinc-900 border border-zinc-800 rounded-[2.5rem] p-8 shadow-xl animate-in">
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="text-left">
                                            <span className={`text-[10px] font-black px-3 py-1.5 rounded-md uppercase tracking-widest border ${sub.checklistType === 'inventory' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-amber-500/10 text-amber-500 border-amber-500/20'}`}>{sub.checklistTitle}</span>
                                            <h4 className="text-3xl font-black uppercase text-white tracking-tight mt-3 italic leading-tight">{sub.bartender}</h4>
                                            <p className="text-zinc-600 text-[10px] font-bold uppercase mt-1 tracking-tighter">{new Date(sub.timestamp).toLocaleString()}</p>
                                        </div>
                                        {sub.checklistType !== 'inventory' && (
                                            <div className="text-4xl font-black text-amber-500 leading-none">{Math.round((sub.completedIndices.length / sub.tasks.length) * 100)}%</div>
                                        )}
                                    </div>
                                    {sub.observations && <div className="p-5 bg-zinc-950 rounded-2xl border border-zinc-800 mb-6 text-sm text-zinc-300 italic flex gap-4"><Icon name="alert-circle" size={20} className="text-amber-500 flex-shrink-0" /><span>"{sub.observations}"</span></div>}
                                    <div className={`grid ${sub.checklistType === 'inventory' ? 'grid-cols-1 gap-2' : 'grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-10'} text-[10px] font-black uppercase tracking-widest`}>
                                        {sub.tasks.map((t, i) => (
                                            sub.checklistType === 'inventory' ? (
                                                <div key={i} className="flex justify-between items-center py-3 border-b border-zinc-800/50">
                                                    <span className="text-zinc-400">{t}</span>
                                                    <span className="text-white text-sm font-black bg-zinc-950 px-3 py-1 rounded-lg border border-zinc-800 flex items-center gap-1">{sub.inventoryValues?.[i] || 0}</span>
                                                </div>
                                            ) : (
                                                <div key={i} className="flex gap-3 items-center py-2 border-b border-zinc-800/30">
                                                    <div className={`w-2.5 h-2.5 rounded-full ${sub.completedIndices.includes(i) ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.4)]'}`}></div>
                                                    <span className={sub.completedIndices.includes(i) ? 'text-zinc-300' : 'text-zinc-700 line-through decoration-zinc-800'}>{t}</span>
                                                </div>
                                            )
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {editingList ? (
                                <ChecklistEditor initialData={editingList} onSave={() => setEditingList(null)} onCancel={() => setEditingList(null)} />
                            ) : (
                                checklists.map(list => (
                                    <div key={list.id} className="bg-zinc-900 border border-zinc-800 p-7 rounded-[2.5rem] flex items-center justify-between group hover:border-amber-500/20 transition-all">
                                        <div className="flex items-center gap-5 text-left">
                                            <div className="w-12 h-12 rounded-2xl bg-zinc-800 flex items-center justify-center text-zinc-500 group-hover:text-amber-500 transition-colors"><Icon name="settings" size={22} /></div>
                                            <div>
                                                <h4 className="font-black text-lg leading-tight uppercase tracking-tighter text-white tracking-widest">{list.title}</h4>
                                                <p className="text-zinc-600 text-[10px] font-black uppercase tracking-widest mt-1 italic">{list.category} {list.type === 'inventory' ? '• Inventario' : ''} • {list.tasks?.length} Ítems</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button onClick={() => setEditingList(list)} className="p-3 bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded-xl transition-all shadow-lg"><Icon name="edit-3" size={18} /></button>
                                            <button onClick={async () => { if (confirm("¿Eliminar protocolo?")) await window.FB.deleteDoc(window.FB.doc(window.FB.db, 'artifacts', window.FB.appId, 'public', 'data', 'checklists', list.id)); }} className="p-3 bg-zinc-800 text-zinc-400 hover:text-red-500 hover:bg-red-500/10 rounded-xl transition-all shadow-lg"><Icon name="trash-2" size={18} /></button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function ChecklistEditor({ initialData, onSave, onCancel }) {
            const [formData, setFormData] = useState(initialData);
            const [draggedIndex, setDraggedIndex] = useState(null);

            const updateTask = (val, idx) => {
                const newTasks = [...formData.tasks];
                newTasks[idx] = val;
                setFormData({ ...formData, tasks: newTasks });
            };

            const addTask = () => {
                setFormData(prev => ({ ...prev, tasks: [...prev.tasks, ""] }));
            };

            const removeTask = (idx) => {
                setFormData(prev => ({ ...prev, tasks: prev.tasks.filter((_, i) => i !== idx) }));
            };

            const onDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;
                const newTasks = [...formData.tasks];
                const item = newTasks[draggedIndex];
                newTasks.splice(draggedIndex, 1);
                newTasks.splice(index, 0, item);
                setDraggedIndex(index);
                setFormData({ ...formData, tasks: newTasks });
            };

            const save = async () => {
                if (!formData.title) { alert("Escribe un título"); return; }
                const finalTasks = formData.tasks.filter(t => t.trim() !== "");
                if (finalTasks.length === 0) { alert("Añade al menos un paso"); return; }

                const { db, collection, doc, addDoc, updateDoc, appId } = window.FB;
                try {
                    const data = { ...formData, tasks: finalTasks };
                    if (formData.id) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklists', formData.id), data);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklists'), data);
                    }
                    onSave();
                } catch (err) { console.error(err); alert("Error de conexión"); }
            };

            return (
                <div className="bg-zinc-900 p-10 rounded-[3rem] border border-zinc-800 space-y-8 animate-in shadow-2xl">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                        <div className="space-y-2">
                            <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Nombre</label>
                            <input className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.title} onChange={e => setFormData({ ...formData, title: e.target.value })} placeholder="Ej: CIERRE BARRA PRINCIPAL" />
                        </div>
                        <div className="space-y-2">
                            <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Categoría / Tipo</label>
                            <select className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.category} onChange={e => setFormData({ ...formData, category: e.target.value })}>
                                <option>Apertura</option><option>Producción</option><option>Inventario</option><option>Cierre</option>
                            </select>
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic">Área Asignada</label>
                        <select className="w-full bg-zinc-950 border border-zinc-800 rounded-2xl p-5 text-white font-black uppercase focus:ring-2 focus:ring-amber-500 outline-none" value={formData.area || 'Barra Principal'} onChange={e => setFormData({ ...formData, area: e.target.value })}>
                            <option>Barra Principal</option><option>Barra Secundaria</option><option>Laboratorio</option>
                        </select>
                    </div>
                    <div className="space-y-4">
                        <label className="text-[10px] font-black uppercase tracking-widest text-zinc-500 ml-2 italic text-amber-500">Pasos (Arrastra para reordenar)</label>
                        <div className="space-y-3 max-h-[45vh] overflow-y-auto pr-2 scrollbar-hide">
                            {formData.tasks.map((t, i) => (
                                <div
                                    key={i}
                                    draggable="true"
                                    onDragStart={(e) => onDragStart(e, i)}
                                    onDragOver={(e) => onDragOver(e, i)}
                                    onDragEnd={() => setDraggedIndex(null)}
                                    className={`flex gap-4 items-center task-row transition-opacity ${draggedIndex === i ? 'opacity-40' : 'opacity-100'}`}
                                >
                                    <div className="drag-handle p-2 text-zinc-700 hover:text-zinc-400 drag-icon transition-colors">
                                        <Icon name="grip-vertical" size={20} />
                                    </div>
                                    <input className="flex-1 bg-zinc-950 border border-zinc-800 rounded-2xl p-4 text-sm text-white focus:border-amber-500/50 outline-none uppercase font-bold" value={t} onChange={e => updateTask(e.target.value, i)} placeholder={`Punto operativo ${i + 1}`} />
                                    <button onClick={() => removeTask(i)} className="p-4 bg-zinc-800 text-zinc-600 hover:text-red-500 rounded-2xl transition-all shadow-lg"><Icon name="trash-2" size={18} /></button>
                                </div>
                            ))}
                        </div>
                        <button onClick={addTask} className="w-full py-5 border border-dashed border-zinc-800 rounded-3xl text-zinc-600 font-black uppercase text-[10px] hover:border-amber-500 hover:text-amber-500 transition-all tracking-[0.25em] shadow-inner">+ Añadir Nuevo Paso</button>
                    </div>
                    <div className="flex gap-5 pt-8 border-t border-zinc-800">
                        <button onClick={save} className="flex-1 bg-amber-500 text-zinc-950 py-5 rounded-[2.5rem] font-black uppercase tracking-[0.25em] shadow-xl active:scale-95 transition-all text-[10px]">Guardar Cambios</button>
                        <button onClick={onCancel} className="px-10 py-5 bg-zinc-800 text-white rounded-[2.5rem] font-black uppercase active:scale-95 transition-all text-[10px] tracking-widest tracking-[0.25em]">Cancelar</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>